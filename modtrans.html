<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة شركة النقل المتطور - Transportation Management System Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap');

        * {
            font-family: 'Cairo', sans-serif;
        }

        .section-container {
            min-height: auto;
            margin-bottom: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 1.8rem;
            margin-bottom: 1.2rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

            .card:hover {
                box-shadow: 0 8px 30px rgba(0,0,0,0.12);
                transform: translateY(-2px);
            }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

            .btn-primary:hover {
                background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
        }

            .btn-success:hover {
                background: linear-gradient(135deg, #0f8b81 0%, #32d671 100%);
                transform: translateY(-2px);
            }

        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(247, 151, 30, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .form-input {
            width: 100%;
            padding: 0.9rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: #fafafa;
        }

            .form-input:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
                background: white;
            }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

            .table th,
            .table td {
                padding: 0.9rem;
                text-align: right;
                border-bottom: 1px solid #e2e8f0;
                vertical-align: middle;
            }

            .table th {
                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                font-weight: 700;
                color: #2d3748;
                border-bottom: 2px solid #cbd5e0;
            }

        .status-badge {
            padding: 0.4rem 1rem;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: 600;
            border: none;
        }

        .status-pending {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
        }

        .status-in-progress {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
        }

        .status-completed {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
        }

        .status-cancelled {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
        }

        .chart-container {
            height: 300px;
            margin: 1rem 0;
            position: relative;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.8rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.8rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.8rem;
        }

        .grid-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.8rem;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4, .grid-5 {
                grid-template-columns: 1fr;
            }
        }

        .nav-tabs {
            display: flex;
            border-bottom: 3px solid #e2e8f0;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .nav-tab {
            padding: 1.2rem 1.8rem;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            background: #f8fafc;
            position: relative;
        }

            .nav-tab.active {
                border-bottom-color: #667eea;
                color: #667eea;
                background: white;
                transform: translateY(3px);
                box-shadow: 0 -2px 15px rgba(102, 126, 234, 0.2);
            }

            .nav-tab:hover {
                background: #f1f5f9;
            }

        .hidden {
            display: none;
        }

        .alert {
            padding: 1.2rem;
            border-radius: 10px;
            margin-bottom: 1.2rem;
            border-left: 5px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            color: #166534;
            border-color: #22c55e;
        }

        .alert-error {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #991b1b;
            border-color: #ef4444;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            color: #92400e;
            border-color: #f59e0b;
        }

        .stats-card {
            text-align: center;
            padding: 2.5rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

            .stats-card::before {
                content: '';
                position: absolute;
                top: -50%;
                right: -50%;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 50%;
                transition: all 0.3s ease;
            }

            .stats-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
            }

                .stats-card:hover::before {
                    top: -20%;
                    right: -20%;
                }

        .stats-number {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.8rem;
            position: relative;
            z-index: 2;
        }

        .stats-label {
            font-size: 1rem;
            opacity: 0.95;
            position: relative;
            z-index: 2;
        }

        .driver-card, .customer-card, .accountant-card, .maintenance-card {
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transition: all 0.3s ease;
        }

            .driver-card:hover, .customer-card:hover, .accountant-card:hover, .maintenance-card:hover {
                border-color: #667eea;
                box-shadow: 0 8px 30px rgba(102, 126, 234, 0.15);
                transform: translateY(-3px);
            }

            .driver-card.active, .accountant-card.active {
                border-color: #22c55e;
                background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            }

        .invoice-section {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 1.5rem;
        }

        .invoice-header {
            text-align: center;
            border-bottom: 3px solid #667eea;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }

        .tax-info {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .low-stock {
            color: #dc2626;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .item-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transition: all 0.3s ease;
        }

            .item-card:hover {
                border-color: #667eea;
                box-shadow: 0 5px 20px rgba(102, 126, 234, 0.1);
            }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2.5rem;
            border-radius: 16px;
            margin-bottom: 2.5rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

            .page-header::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="20" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="20" cy="80" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
                animation: float 20s infinite linear;
            }

        @keyframes float {
            0% {
                transform: translateY(0) translateX(0);
            }

            100% {
                transform: translateY(-100px) translateX(-100px);
            }
        }

        .form-section {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            padding: 2rem;
            border: 2px solid #e2e8f0;
        }

        .compact-table {
            font-size: 0.85rem;
        }

            .compact-table th,
            .compact-table td {
                padding: 0.6rem;
            }

        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-form {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(34, 197, 94, 0.3);
            z-index: 1000;
            animation: slideInLeft 0.3s ease;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .maintenance-alert {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            animation: shake 0.5s infinite alternate;
        }

        @keyframes shake {
            from {
                transform: translateX(-2px);
            }

            to {
                transform: translateX(2px);
            }
        }

        .crm-status {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

            .crm-status.hot {
                background: linear-gradient(135deg, #fee2e2, #fecaca);
                color: #991b1b;
            }

            .crm-status.warm {
                background: linear-gradient(135deg, #fef3c7, #fde68a);
                color: #92400e;
            }

            .crm-status.cold {
                background: linear-gradient(135deg, #dbeafe, #bfdbfe);
                color: #1e40af;
            }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .payment-method {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .payment-method:hover, .payment-method.selected {
                border-color: #667eea;
                background: #f0f4ff;
            }

        .qr-code-container {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            margin: 1rem 0;
        }

        /* Print styles for PDF export */
        @media print {
            .no-print {
                display: none !important;
            }

            .card {
                break-inside: avoid;
                margin-bottom: 1rem;
                box-shadow: none;
                border: 1px solid #ccc;
            }

            body {
                font-size: 12px;
            }

            .nav-tabs {
                display: none;
            }

            .section-container {
                display: block !important;
            }

            .hidden {
                display: block !important;
            }
        }

        .security-badge {
            display: inline-block;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .audit-log {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.8rem;
            margin: 0.5rem 0;
            font-size: 0.85rem;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50">
    <!-- Login Container -->
    <div id="loginContainer" class="login-container">
        <div class="login-form">
            <div class="mb-6">
                <i class="fas fa-truck text-4xl text-blue-600 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800">تسجيل الدخول</h2>
                <p class="text-gray-600 mt-2">نظام إدارة شركة النقل المتطور</p>
            </div>
            <div class="mb-4">
                <input type="text" id="loginUsername" placeholder="اسم المستخدم" class="form-input">
                <input type="password" id="loginPassword" placeholder="كلمة المرور" class="form-input">
            </div>
            <button onclick="login()" class="btn btn-primary w-full mb-4">
                <i class="fas fa-sign-in-alt"></i>دخول
            </button>
            <div class="text-sm text-gray-600">
                <p><strong>بيانات التجربة:</strong></p>
                <p>المدير: admin / admin123</p>
                <p>محاسب: accountant / acc123</p>
                <p>سائق: driver / drv123</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <!-- Page Header -->
        <div class="page-header">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center">
                    <div class="flex items-center relative z-10">
                        <i class="fas fa-truck text-4xl ml-4"></i>
                        <div>
                            <h1 class="text-4xl font-bold">نظام إدارة شركة النقل المتطور</h1>
                            <p class="text-blue-100 mt-2 text-lg">نظام متكامل مع إدارة المستخدمين، CRM، الصيانة، والدفع الإلكتروني</p>
                            <span id="userInfo" class="security-badge">
                                <i class="fas fa-user"></i>مرحباً، <span id="currentUser"></span>
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4 space-x-reverse relative z-10">
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <label class="text-sm font-medium">العملة:</label>
                            <select id="currencySelect" onchange="changeCurrency()" class="form-input bg-white text-gray-900" style="width: auto; margin: 0; padding: 0.5rem;">
                                <option value="ر.س">ر.س ريال سعودي</option>
                                <option value="$">$ دولار</option>
                                <option value="€">€ يورو</option>
                            </select>
                        </div>
                        <button onclick="exportDataJSON()" class="btn btn-primary no-print">
                            <i class="fas fa-download"></i>تصدير JSON
                        </button>
                        <button onclick="exportDataExcel()" class="btn btn-success no-print">
                            <i class="fas fa-file-excel"></i>تصدير Excel
                        </button>
                        <button onclick="importData()" class="btn btn-info no-print">
                            <i class="fas fa-upload"></i>استيراد البيانات
                        </button>
                        <button onclick="logout()" class="btn btn-warning no-print">
                            <i class="fas fa-sign-out-alt"></i>خروج
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="max-w-7xl mx-auto px-4">
            <div class="nav-tabs no-print">
                <div class="nav-tab active" onclick="showTab('dashboard')">
                    <i class="fas fa-tachometer-alt ml-2"></i>لوحة التحكم
                </div>
                <div id="itemsTab" class="nav-tab" onclick="showTab('items')">
                    <i class="fas fa-boxes ml-2"></i>إدارة الأصناف
                </div>
                <div id="ordersTab" class="nav-tab" onclick="showTab('orders')">
                    <i class="fas fa-clipboard-list ml-2"></i>إدارة الطلبات
                </div>
                <div class="nav-tab" onclick="showTab('customers')">
                    <i class="fas fa-users ml-2"></i>إدارة العملاء CRM
                </div>
                <div id="driversTab" class="nav-tab" onclick="showTab('drivers')">
                    <i class="fas fa-user-tie ml-2"></i>إدارة السائقين
                </div>
                <div class="nav-tab" onclick="showTab('maintenance')">
                    <i class="fas fa-tools ml-2"></i>إدارة الصيانة
                </div>
                <div id="accountantsTab" class="nav-tab" onclick="showTab('accountants')">
                    <i class="fas fa-calculator ml-2"></i>إدارة المحاسبين
                </div>
                <div class="nav-tab" onclick="showTab('payments')">
                    <i class="fas fa-credit-card ml-2"></i>نظام الدفع
                </div>
                <div class="nav-tab" onclick="showTab('analytics')">
                    <i class="fas fa-chart-bar ml-2"></i>التقارير المتقدمة
                </div>
                <div id="securityTab" class="nav-tab" onclick="showTab('security')">
                    <i class="fas fa-shield-alt ml-2"></i>الأمان والمراجعة
                </div>
                <input type="text" id="searchInput" placeholder="بحث سريع..." class="form-input mb-3" onkeyup="globalSearch()">
            </div>

            <!-- Notification Container -->
            <div id="notificationContainer"></div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Maintenance Alerts -->
            <div id="maintenanceAlerts"></div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="section-container">
                <div class="grid-5 mb-8">
                    <div class="stats-card">
                        <div class="stats-number" id="totalOrders">0</div>
                        <div class="stats-label">طلبات اليوم</div>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stats-number" id="totalRevenue">0</div>
                        <div class="stats-label">إجمالي الإيرادات</div>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stats-number" id="totalCustomers">0</div>
                        <div class="stats-label">إجمالي العملاء</div>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stats-number" id="totalDrivers">0</div>
                        <div class="stats-label">السائقين النشطين</div>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                        <div class="stats-number" id="totalItems">0</div>
                        <div class="stats-label">الأصناف المتوفرة</div>
                    </div>
                </div>

                <div class="grid-3 mb-8">
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-line ml-2 text-blue-600"></i>نظرة عامة على المبيعات
                        </h3>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-star ml-2 text-yellow-600"></i>الأصناف الأكثر طلباً
                        </h3>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="popularItemsChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-bell ml-2 text-red-600"></i>التنبيهات الذكية
                        </h3>
                        <div id="smartAlerts">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle ml-2"></i>
                                يوجد 3 مركبات تحتاج صيانة دورية
                            </div>
                            <div class="alert alert-error">
                                <i class="fas fa-warehouse ml-2"></i>
                                انخفاض مخزون في 2 من الأصناف
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-clock ml-2 text-green-600"></i>الطلبات الأخيرة مع التفاصيل المالية
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="table compact-table">
                            <thead>
                                <tr>
                                    <th>رقم الطلب</th>
                                    <th>العميل</th>
                                    <th>المحاسب</th>
                                    <th>السائق</th>
                                    <th>من</th>
                                    <th>إلى</th>
                                    <th>المبلغ (قبل الضريبة)</th>
                                    <th>الضريبة (15%)</th>
                                    <th>المبلغ الإجمالي</th>
                                    <th>حالة الدفع</th>
                                    <th>الحالة</th>
                                    <th>التاريخ</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrdersTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Items Management Tab -->
            <div id="items" class="section-container hidden">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-boxes ml-3 text-blue-600"></i>إدارة الأصناف المتقدمة
                        </h3>
                        <div class="flex gap-3">
                            <button onclick="showAddItemForm()" class="btn btn-primary no-print">
                                <i class="fas fa-plus"></i>إضافة صنف جديد
                            </button>
                            <button onclick="generateQRForAllItems()" class="btn btn-info no-print">
                                <i class="fas fa-qrcode"></i>QR لجميع الأصناف
                            </button>
                        </div>
                    </div>

                    <!-- Add Item Form -->
                    <div id="addItemForm" class="hidden form-section mb-6">
                        <h4 class="font-semibold mb-4 text-xl">إضافة صنف جديد</h4>
                        <div class="grid-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">اسم الصنف *</label>
                                <input type="text" id="itemName" placeholder="مثل: بلوك، قمح، أسمنت..." class="form-input">
                                <label class="block text-sm font-medium mb-2">السعر للوحدة *</label>
                                <input type="number" id="itemPrice" placeholder="السعر" step="0.01" class="form-input">
                                <label class="block text-sm font-medium mb-2">الحد الأدنى للمخزون</label>
                                <input type="number" id="itemMinStock" placeholder="الحد الأدنى للتنبيه" min="1" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">الكمية المتوفرة *</label>
                                <input type="number" id="itemStock" placeholder="الكمية" min="0" class="form-input">
                                <label class="block text-sm font-medium mb-2">وحدة القياس *</label>
                                <select id="itemUnit" class="form-input">
                                    <option value="">اختر الوحدة</option>
                                    <option value="طن">طن</option>
                                    <option value="كيلو">كيلو</option>
                                    <option value="قطعة">قطعة</option>
                                    <option value="متر مكعب">متر مكعب</option>
                                    <option value="لتر">لتر</option>
                                    <option value="كيس">كيس</option>
                                    <option value="صندوق">صندوق</option>
                                </select>
                                <label class="block text-sm font-medium mb-2">الموقع في المخزن</label>
                                <input type="text" id="itemLocation" placeholder="رف A - موقع 1" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">فئة الصنف</label>
                                <select id="itemCategory" class="form-input">
                                    <option value="">اختر الفئة</option>
                                    <option value="مواد-بناء">مواد بناء</option>
                                    <option value="مواد-غذائية">مواد غذائية</option>
                                    <option value="مواد-خام">مواد خام</option>
                                    <option value="أجهزة">أجهزة</option>
                                    <option value="أثاث">أثاث</option>
                                    <option value="أخرى">أخرى</option>
                                </select>
                                <label class="block text-sm font-medium mb-2">وصف الصنف</label>
                                <textarea id="itemDescription" placeholder="وصف مختصر للصنف" class="form-input" rows="2"></textarea>
                                <label class="block text-sm font-medium mb-2">الرمز التعريفي</label>
                                <input type="text" id="itemSKU" placeholder="SKU-001" class="form-input">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="addItem()" class="btn btn-success">إضافة الصنف</button>
                            <button onclick="hideAddItemForm()" class="btn" style="background: #6b7280; color: white;">إلغاء</button>
                        </div>
                    </div>

                    <!-- Items List -->
                    <div id="itemsList"></div>
                </div>
            </div>

            <!-- Orders Management Tab -->
            <div id="orders" class="section-container hidden">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-clipboard-list ml-3 text-green-600"></i>إدارة الطلبات المتقدمة
                        </h3>
                        <button onclick="showCreateOrderForm()" class="btn btn-primary no-print">
                            <i class="fas fa-plus"></i>إنشاء طلب جديد
                        </button>
                    </div>

                    <div class="tax-info">
                        <h4 class="font-bold text-amber-800 mb-3 text-lg">
                            <i class="fas fa-info-circle ml-2"></i>معلومات الضريبة والدفع الإلكتروني
                        </h4>
                        <p class="text-sm text-amber-700">
                            جميع الطلبات تخضع لضريبة القيمة المضافة بنسبة 15% حسب لوائح المملكة العربية السعودية.
                            يتم دعم الدفع الإلكتروني عبر مختلف الطرق ويمكن إنشاء QR Code للفواتير.
                        </p>
                    </div>

                    <!-- Create Order Form -->
                    <div id="createOrderForm" class="hidden form-section mb-6">
                        <h4 class="font-semibold mb-4 text-xl">إنشاء طلب نقل جديد</h4>
                        <div class="grid-2">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">العميل *</label>
                                    <select id="orderCustomer" class="form-input" required>
                                        <option value="">اختر العميل</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">المحاسب المسؤول *</label>
                                    <select id="orderAccountant" class="form-input" required>
                                        <option value="">اختر المحاسب</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">السائق *</label>
                                    <select id="orderDriver" class="form-input" required>
                                        <option value="">اختر السائق</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">أولوية الطلب</label>
                                    <select id="orderPriority" class="form-input">
                                        <option value="normal">عادي</option>
                                        <option value="high">عالي</option>
                                        <option value="urgent">عاجل</option>
                                    </select>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">من (مكان الاستلام) *</label>
                                    <input type="text" id="orderFromLocation" placeholder="عنوان الاستلام" class="form-input" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">إلى (مكان التسليم) *</label>
                                    <input type="text" id="orderToLocation" placeholder="عنوان التسليم" class="form-input" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">تاريخ ووقت النقل</label>
                                    <input type="datetime-local" id="orderDateTime" class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">المسافة المقدرة (كم)</label>
                                    <input type="number" id="orderDistance" placeholder="المسافة" step="0.1" class="form-input">
                                </div>
                            </div>
                        </div>

                        <div class="mt-6">
                            <label class="block text-sm font-medium mb-3">أصناف الطلب</label>
                            <div id="orderItemsContainer" class="mb-4">
                                <!-- Order items will be added here -->
                            </div>
                            <button type="button" onclick="addOrderItemField()" class="btn btn-info mb-4">
                                <i class="fas fa-plus"></i>إضافة صنف للطلب
                            </button>
                        </div>

                        <div class="grid-2 mt-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">طريقة الدفع المفضلة</label>
                                <select id="orderPaymentMethod" class="form-input">
                                    <option value="cash">نقداً</option>
                                    <option value="bank-transfer">تحويل بنكي</option>
                                    <option value="credit-card">بطاقة ائتمانية</option>
                                    <option value="stc-pay">STC Pay</option>
                                    <option value="apple-pay">Apple Pay</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">ملاحظات</label>
                                <textarea id="orderNotes" placeholder="ملاحظات خاصة بالطلب" class="form-input" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            <button onclick="createOrder()" class="btn btn-success">إنشاء الطلب</button>
                            <button onclick="hideCreateOrderForm()" class="btn" style="background: #6b7280; color: white;">إلغاء</button>
                        </div>
                    </div>

                    <!-- Orders List -->
                    <div class="overflow-x-auto">
                        <table class="table compact-table">
                            <thead>
                                <tr>
                                    <th>رقم الطلب</th>
                                    <th>العميل</th>
                                    <th>المحاسب</th>
                                    <th>السائق</th>
                                    <th>من</th>
                                    <th>إلى</th>
                                    <th>المبلغ قبل الضريبة</th>
                                    <th>الضريبة (15%)</th>
                                    <th>المبلغ الإجمالي</th>
                                    <th>طريقة الدفع</th>
                                    <th>حالة الدفع</th>
                                    <th>الحالة</th>
                                    <th>الأولوية</th>
                                    <th>التاريخ</th>
                                    <th class="no-print">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customers CRM Management Tab -->
            <div id="customers" class="section-container hidden">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-users ml-3 text-purple-600"></i>نظام إدارة علاقات العملاء CRM المتطور
                        </h3>
                        <div class="flex gap-3">
                            <button onclick="showAddCustomerForm()" class="btn btn-primary no-print">
                                <i class="fas fa-plus"></i>إضافة عميل جديد
                            </button>
                            <button onclick="exportCustomersAnalysis()" class="btn btn-info no-print">
                                <i class="fas fa-chart-line"></i>تحليل العملاء
                            </button>
                        </div>
                    </div>

                    <!-- Add Customer Form -->
                    <div id="addCustomerForm" class="hidden form-section mb-6">
                        <h4 class="font-semibold mb-4 text-xl">إضافة عميل جديد</h4>
                        <div class="grid-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">اسم العميل *</label>
                                <input type="text" id="customerName" placeholder="الاسم الكامل أو اسم الشركة" class="form-input" required>
                                <label class="block text-sm font-medium mb-2">رقم الهاتف *</label>
                                <input type="tel" id="customerPhone" placeholder="05xxxxxxxx" class="form-input" required>
                                <label class="block text-sm font-medium mb-2">البريد الإلكتروني</label>
                                <input type="email" id="customerEmail" placeholder="example@domain.com" class="form-input">
                                <label class="block text-sm font-medium mb-2">نوع العميل</label>
                                <select id="customerType" class="form-input">
                                    <option value="individual">فرد</option>
                                    <option value="company">شركة</option>
                                    <option value="government">حكومي</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">العنوان</label>
                                <textarea id="customerAddress" placeholder="العنوان التفصيلي" class="form-input" rows="2"></textarea>
                                <label class="block text-sm font-medium mb-2">الرقم الضريبي (للشركات)</label>
                                <input type="text" id="customerTaxNumber" placeholder="الرقم الضريبي" class="form-input">
                                <label class="block text-sm font-medium mb-2">تاريخ التسجيل</label>
                                <input type="date" id="customerJoinDate" class="form-input" value="">
                                <label class="block text-sm font-medium mb-2">تصنيف العميل</label>
                                <select id="customerSegment" class="form-input">
                                    <option value="hot">عميل ساخن</option>
                                    <option value="warm">عميل دافئ</option>
                                    <option value="cold">عميل بارد</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">مصدر العميل</label>
                                <select id="customerSource" class="form-input">
                                    <option value="referral">إحالة</option>
                                    <option value="website">موقع إلكتروني</option>
                                    <option value="social-media">وسائل التواصل</option>
                                    <option value="advertisement">إعلان</option>
                                    <option value="cold-call">اتصال مبرد</option>
                                </select>
                                <label class="block text-sm font-medium mb-2">ملاحظات خاصة</label>
                                <textarea id="customerNotes" placeholder="ملاحظات عن العميل" class="form-input" rows="2"></textarea>
                                <label class="block text-sm font-medium mb-2">حد الائتمان</label>
                                <input type="number" id="customerCreditLimit" placeholder="الحد الأقصى للائتمان" step="0.01" class="form-input">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="addCustomer()" class="btn btn-success">إضافة العميل</button>
                            <button onclick="hideAddCustomerForm()" class="btn" style="background: #6b7280; color: white;">إلغاء</button>
                        </div>
                    </div>

                    <!-- CRM Analytics -->
                    <div class="grid-3 mb-6">
                        <div class="card" style="background: linear-gradient(135deg, #fee2e2, #fecaca);">
                            <h4 class="font-bold text-red-800 mb-2">العملاء الساخنون</h4>
                            <div class="text-2xl font-bold text-red-600" id="hotCustomersCount">0</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                            <h4 class="font-bold text-yellow-800 mb-2">العملاء الدافئون</h4>
                            <div class="text-2xl font-bold text-yellow-600" id="warmCustomersCount">0</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">
                            <h4 class="font-bold text-blue-800 mb-2">العملاء الباردون</h4>
                            <div class="text-2xl font-bold text-blue-600" id="coldCustomersCount">0</div>
                        </div>
                    </div>

                    <!-- Customers List -->
                    <div class="grid-2" id="customersList">
                    </div>
                </div>
            </div>

            <!-- Drivers Management Tab -->
            <div id="drivers" class="section-container hidden">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-user-tie ml-3 text-indigo-600"></i>إدارة السائقين والمركبات
                        </h3>
                        <div class="flex gap-3">
                            <button onclick="showAddDriverForm()" class="btn btn-primary no-print">
                                <i class="fas fa-plus"></i>إضافة سائق جديد
                            </button>
                            <button onclick="checkDriverLicenses()" class="btn btn-warning no-print">
                                <i class="fas fa-calendar-check"></i>فحص انتهاء الرخص
                            </button>
                        </div>
                    </div>

                    <!-- Add Driver Form -->
                    <div id="addDriverForm" class="hidden form-section mb-6">
                        <h4 class="font-semibold mb-4 text-xl">إضافة سائق جديد</h4>
                        <div class="grid-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">اسم السائق *</label>
                                <input type="text" id="driverName" placeholder="الاسم الكامل" class="form-input" required>
                                <label class="block text-sm font-medium mb-2">رقم الهوية/الإقامة *</label>
                                <input type="text" id="driverIdNumber" placeholder="رقم الهوية أو الإقامة" class="form-input" required>
                                <label class="block text-sm font-medium mb-2">رقم الهاتف *</label>
                                <input type="tel" id="driverPhone" placeholder="05xxxxxxxx" class="form-input" required>
                                <label class="block text-sm font-medium mb-2">تاريخ الميلاد</label>
                                <input type="date" id="driverBirthDate" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">رقم رخصة القيادة *</label>
                                <input type="text" id="driverLicense" placeholder="رقم رخصة القيادة" class="form-input" required>
                                <label class="block text-sm font-medium mb-2">تاريخ انتهاء الرخصة *</label>
                                <input type="date" id="driverLicenseExpiry" class="form-input" required>
                                <label class="block text-sm font-medium mb-2">رقم المركبة *</label>
                                <input type="text" id="driverCarId" placeholder="رقم لوحة المركبة" class="form-input" required>
                                <label class="block text-sm font-medium mb-2">نوع المركبة</label>
                                <select id="driverCarType" class="form-input">
                                    <option value="">اختر نوع المركبة</option>
                                    <option value="شاحنة-صغيرة">شاحنة صغيرة</option>
                                    <option value="شاحنة-متوسطة">شاحنة متوسطة</option>
                                    <option value="شاحنة-كبيرة">شاحنة كبيرة</option>
                                    <option value="مقطورة">مقطورة</option>
                                    <option value="نقل-خفيف">نقل خفيف</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">تاريخ التعيين</label>
                                <input type="date" id="driverHireDate" class="form-input">
                                <label class="block text-sm font-medium mb-2">الراتب الشهري</label>
                                <input type="number" id="driverSalary" placeholder="الراتب" step="0.01" class="form-input">
                                <label class="block text-sm font-medium mb-2">حالة العمل</label>
                                <select id="driverEmploymentStatus" class="form-input">
                                    <option value="full-time">دوام كامل</option>
                                    <option value="part-time">دوام جزئي</option>
                                    <option value="contract">تعاقد</option>
                                </select>
                                <label class="block text-sm font-medium mb-2">تقييم الأداء</label>
                                <select id="driverRating" class="form-input">
                                    <option value="5">ممتاز</option>
                                    <option value="4">جيد جداً</option>
                                    <option value="3">جيد</option>
                                    <option value="2">مقبول</option>
                                    <option value="1">ضعيف</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="addDriver()" class="btn btn-success">إضافة السائق</button>
                            <button onclick="hideAddDriverForm()" class="btn" style="background: #6b7280; color: white;">إلغاء</button>
                        </div>
                    </div>

                    <!-- Drivers List -->
                    <div class="grid-2" id="driversList">
                    </div>
                </div>
            </div>

            <!-- Maintenance Management Tab -->
            <div id="maintenance" class="section-container hidden">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-tools ml-3 text-orange-600"></i>إدارة الصيانة والمركبات
                        </h3>
                        <div class="flex gap-3">
                            <button onclick="showAddMaintenanceForm()" class="btn btn-primary no-print">
                                <i class="fas fa-plus"></i>إضافة سجل صيانة
                            </button>
                            <button onclick="scheduleMaintenanceCheck()" class="btn btn-warning no-print">
                                <i class="fas fa-calendar-alt"></i>فحص جدولة الصيانة
                            </button>
                        </div>
                    </div>

                    <!-- Add Maintenance Form -->
                    <div id="addMaintenanceForm" class="hidden form-section mb-6">
                        <h4 class="font-semibold mb-4 text-xl">إضافة سجل صيانة جديد</h4>
                        <div class="grid-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">المركبة *</label>
                                <select id="maintenanceVehicle" class="form-input" required>
                                    <option value="">اختر المركبة</option>
                                </select>
                                <label class="block text-sm font-medium mb-2">نوع الصيانة *</label>
                                <select id="maintenanceType" class="form-input" required>
                                    <option value="">اختر نوع الصيانة</option>
                                    <option value="دورية">صيانة دورية</option>
                                    <option value="إصلاح">إصلاح</option>
                                    <option value="تغيير-زيت">تغيير زيت</option>
                                    <option value="إطارات">صيانة إطارات</option>
                                    <option value="كهربائي">نظام كهربائي</option>
                                    <option value="فرامل">نظام الفرامل</option>
                                </select>
                                <label class="block text-sm font-medium mb-2">تاريخ الصيانة *</label>
                                <input type="date" id="maintenanceDate" class="form-input" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">التكلفة</label>
                                <input type="number" id="maintenanceCost" placeholder="تكلفة الصيانة" step="0.01" class="form-input">
                                <label class="block text-sm font-medium mb-2">المسافة عند الصيانة (كم)</label>
                                <input type="number" id="maintenanceMileage" placeholder="قراءة العداد" class="form-input">
                                <label class="block text-sm font-medium mb-2">الصيانة التالية بعد (كم)</label>
                                <input type="number" id="maintenanceNextMileage" placeholder="المسافة للصيانة التالية" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">المزود/الورشة</label>
                                <input type="text" id="maintenanceProvider" placeholder="اسم الورشة أو المزود" class="form-input">
                                <label class="block text-sm font-medium mb-2">وصف الأعمال المنجزة</label>
                                <textarea id="maintenanceDescription" placeholder="تفاصيل الصيانة المنجزة" class="form-input" rows="3"></textarea>
                                <label class="block text-sm font-medium mb-2">حالة المركبة بعد الصيانة</label>
                                <select id="maintenanceStatus" class="form-input">
                                    <option value="excellent">ممتازة</option>
                                    <option value="good">جيدة</option>
                                    <option value="fair">مقبولة</option>
                                    <option value="poor">تحتاج متابعة</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="addMaintenance()" class="btn btn-success">إضافة السجل</button>
                            <button onclick="hideAddMaintenanceForm()" class="btn" style="background: #6b7280; color: white;">إلغاء</button>
                        </div>
                    </div>

                    <!-- Maintenance Records -->
                    <div id="maintenanceList">
                        <h4 class="text-lg font-semibold mb-4">سجلات الصيانة</h4>
                        <div class="overflow-x-auto">
                            <table class="table compact-table">
                                <thead>
                                    <tr>
                                        <th>المركبة</th>
                                        <th>نوع الصيانة</th>
                                        <th>التاريخ</th>
                                        <th>التكلفة</th>
                                        <th>المسافة</th>
                                        <th>المزود</th>
                                        <th>الحالة</th>
                                        <th>الصيانة التالية</th>
                                        <th class="no-print">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenanceTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accountants Management Tab -->
            <div id="accountants" class="section-container hidden">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-calculator ml-3 text-green-600"></i>إدارة المحاسبين والمالية
                        </h3>
                        <button onclick="showAddAccountantForm()" class="btn btn-primary no-print">
                            <i class="fas fa-plus"></i>إضافة محاسب جديد
                        </button>
                    </div>

                    <!-- Add Accountant Form -->
                    <div id="addAccountantForm" class="hidden form-section mb-6">
                        <h4 class="font-semibold mb-4 text-xl">إضافة محاسب جديد</h4>
                        <div class="grid-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">اسم المحاسب *</label>
                                <input type="text" id="accountantName" placeholder="الاسم الكامل" class="form-input" required>
                                <label class="block text-sm font-medium mb-2">رقم الهاتف *</label>
                                <input type="tel" id="accountantPhone" placeholder="05xxxxxxxx" class="form-input" required>
                                <label class="block text-sm font-medium mb-2">البريد الإلكتروني *</label>
                                <input type="email" id="accountantEmail" placeholder="example@domain.com" class="form-input" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">رقم الموظف *</label>
                                <input type="text" id="accountantEmployeeId" placeholder="رقم الموظف" class="form-input" required>
                                <label class="block text-sm font-medium mb-2">المسمى الوظيفي</label>
                                <input type="text" id="accountantPosition" placeholder="مثل: محاسب، مدير حسابات..." class="form-input">
                                <label class="block text-sm font-medium mb-2">تاريخ التعيين</label>
                                <input type="date" id="accountantHireDate" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">مستوى الصلاحية</label>
                                <select id="accountantAccessLevel" class="form-input">
                                    <option value="basic">محاسب أساسي</option>
                                    <option value="advanced">محاسب متقدم</option>
                                    <option value="manager">مدير مالي</option>
                                </select>
                                <label class="block text-sm font-medium mb-2">الراتب الشهري</label>
                                <input type="number" id="accountantSalary" placeholder="الراتب" step="0.01" class="form-input">
                                <label class="block text-sm font-medium mb-2">ملاحظات</label>
                                <textarea id="accountantNotes" placeholder="ملاحظات إضافية" class="form-input" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="addAccountant()" class="btn btn-success">إضافة المحاسب</button>
                            <button onclick="hideAddAccountantForm()" class="btn" style="background: #6b7280; color: white;">إلغاء</button>
                        </div>
                    </div>

                    <!-- Accountants List -->
                    <div class="grid-2" id="accountantsList">
                    </div>
                </div>
            </div>

            <!-- Payment System Tab -->
            <div id="payments" class="section-container hidden">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-credit-card ml-3 text-blue-600"></i>نظام الدفع الإلكتروني المتطور
                        </h3>
                        <button onclick="processPayment()" class="btn btn-primary no-print">
                            <i class="fas fa-money-bill-wave"></i>معالجة دفعة جديدة
                        </button>
                    </div>

                    <!-- Payment Methods -->
                    <div class="grid-2 mb-8">
                        <div class="card">
                            <h4 class="text-lg font-semibold mb-4">طرق الدفع المتاحة</h4>
                            <div class="payment-methods">
                                <div class="payment-method" data-method="cash">
                                    <i class="fas fa-money-bill-alt text-2xl text-green-600"></i>
                                    <p class="mt-2 text-sm font-medium">نقداً</p>
                                </div>
                                <div class="payment-method" data-method="bank">
                                    <i class="fas fa-university text-2xl text-blue-600"></i>
                                    <p class="mt-2 text-sm font-medium">تحويل بنكي</p>
                                </div>
                                <div class="payment-method" data-method="card">
                                    <i class="fas fa-credit-card text-2xl text-purple-600"></i>
                                    <p class="mt-2 text-sm font-medium">بطاقة ائتمانية</p>
                                </div>
                                <div class="payment-method" data-method="stc">
                                    <i class="fas fa-mobile-alt text-2xl text-purple-600"></i>
                                    <p class="mt-2 text-sm font-medium">STC Pay</p>
                                </div>
                                <div class="payment-method" data-method="apple">
                                    <i class="fab fa-apple text-2xl text-gray-800"></i>
                                    <p class="mt-2 text-sm font-medium">Apple Pay</p>
                                </div>
                                <div class="payment-method" data-method="mada">
                                    <i class="fas fa-credit-card text-2xl text-green-600"></i>
                                    <p class="mt-2 text-sm font-medium">مدى</p>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h4 class="text-lg font-semibold mb-4">إحصائيات الدفع</h4>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span>المدفوع اليوم:</span>
                                    <span id="todayPayments" class="font-bold text-green-600">0 ر.س</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>المعلق:</span>
                                    <span id="pendingPayments" class="font-bold text-yellow-600">0 ر.س</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>المتأخر:</span>
                                    <span id="overduePayments" class="font-bold text-red-600">0 ر.س</span>
                                </div>
                                <div class="flex justify-between items-center border-t pt-2">
                                    <span>الإجمالي الشهري:</span>
                                    <span id="monthlyPayments" class="font-bold text-blue-600">0 ر.س</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Form -->
                    <div id="paymentForm" class="form-section mb-6">
                        <h4 class="font-semibold mb-4 text-xl">معالجة دفعة جديدة</h4>
                        <div class="grid-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">الطلب المراد دفعه</label>
                                <select id="paymentOrder" class="form-input">
                                    <option value="">اختر الطلب</option>
                                </select>
                                <label class="block text-sm font-medium mb-2">طريقة الدفع *</label>
                                <select id="paymentMethodSelect" class="form-input" required>
                                    <option value="">اختر طريقة الدفع</option>
                                    <option value="cash">نقداً</option>
                                    <option value="bank-transfer">تحويل بنكي</option>
                                    <option value="credit-card">بطاقة ائتمانية</option>
                                    <option value="stc-pay">STC Pay</option>
                                    <option value="apple-pay">Apple Pay</option>
                                    <option value="mada">مدى</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">المبلغ المدفوع *</label>
                                <input type="number" id="paymentAmount" placeholder="المبلغ" step="0.01" class="form-input" required>
                                <label class="block text-sm font-medium mb-2">تاريخ الدفع</label>
                                <input type="datetime-local" id="paymentDate" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">رقم المرجع/الإيصال</label>
                                <input type="text" id="paymentReference" placeholder="رقم الإيصال أو المرجع" class="form-input">
                                <label class="block text-sm font-medium mb-2">ملاحظات الدفع</label>
                                <textarea id="paymentNotes" placeholder="ملاحظات إضافية" class="form-input" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="submitPayment()" class="btn btn-success">
                                <i class="fas fa-check"></i>تأكيد الدفع
                            </button>
                            <button onclick="generatePaymentQR()" class="btn btn-info">
                                <i class="fas fa-qrcode"></i>إنشاء QR للدفع
                            </button>
                        </div>
                    </div>

                    <!-- QR Code Display -->
                    <div id="paymentQRContainer" class="qr-code-container hidden">
                        <h4 class="text-lg font-semibold mb-4">رمز QR للدفع</h4>
                        <div id="paymentQRCode"></div>
                        <p class="text-sm text-gray-600 mt-2">اسمح للعميل بمسح الكود للدفع</p>
                    </div>

                    <!-- Payment History -->
                    <div class="card">
                        <h4 class="text-lg font-semibold mb-4">سجل المدفوعات</h4>
                        <div class="overflow-x-auto">
                            <table class="table compact-table">
                                <thead>
                                    <tr>
                                        <th>رقم الطلب</th>
                                        <th>العميل</th>
                                        <th>المبلغ المدفوع</th>
                                        <th>طريقة الدفع</th>
                                        <th>تاريخ الدفع</th>
                                        <th>رقم المرجع</th>
                                        <th>الحالة</th>
                                        <th class="no-print">إيصال</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Analytics Tab -->
            <div id="analytics" class="section-container hidden">
                <div class="grid-2 mb-8">
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-area ml-2 text-blue-600"></i>الإيرادات الشهرية المتقدمة
                        </h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="monthlyRevenueChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-pie ml-2 text-purple-600"></i>توزيع حالة الطلبات
                        </h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="orderStatusChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid-2 mb-8">
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-boxes ml-2 text-green-600"></i>أداء الأصناف
                        </h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="categoryPerformanceChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-users-cog ml-2 text-indigo-600"></i>أداء السائقين
                        </h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="driversPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card mb-8">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-warehouse ml-2 text-yellow-600"></i>مستويات المخزون الحالية مع التنبيهات
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="table compact-table">
                            <thead>
                                <tr>
                                    <th>اسم الصنف</th>
                                    <th>الفئة</th>
                                    <th>المخزون الحالي</th>
                                    <th>الحد الأدنى</th>
                                    <th>الموقع</th>
                                    <th>الوحدة</th>
                                    <th>الحالة</th>
                                    <th>إجراء مقترح</th>
                                </tr>
                            </thead>
                            <tbody id="stockLevelsTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Advanced VAT Summary -->
                <div class="card mb-8">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-receipt ml-2 text-red-600"></i>ملخص ضريبة القيمة المضافة المتقدم
                    </h3>
                    <div class="grid-4">
                        <div class="text-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="text-3xl font-bold text-blue-600" id="vatTotalOrders">0</div>
                            <div class="text-sm text-gray-600">إجمالي الطلبات</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg border border-green-200">
                            <div class="text-3xl font-bold text-green-600" id="vatTotalSales">0</div>
                            <div class="text-sm text-gray-600">إجمالي المبيعات قبل الضريبة</div>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div class="text-3xl font-bold text-yellow-600" id="vatTotalTax">0</div>
                            <div class="text-sm text-gray-600">إجمالي ضريبة القيمة المضافة</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg border border-purple-200">
                            <div class="text-3xl font-bold text-purple-600" id="vatTotalWithTax">0</div>
                            <div class="text-sm text-gray-600">إجمالي المبيعات مع الضريبة</div>
                        </div>
                    </div>
                </div>

                <!-- Profitability Analysis -->
                <div class="card">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-line ml-2 text-green-600"></i>تحليل الربحية والتكاليف
                    </h3>
                    <div class="grid-3">
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="totalProfit">0</div>
                            <div class="text-sm text-gray-600">إجمالي الأرباح المقدرة</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-2xl font-bold text-red-600" id="totalExpenses">0</div>
                            <div class="text-sm text-gray-600">إجمالي المصروفات</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="profitMargin">0%</div>
                            <div class="text-sm text-gray-600">هامش الربح</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security and Audit Tab -->
            <div id="security" class="section-container hidden">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-shield-alt ml-3 text-red-600"></i>الأمان ومراجعة العمليات
                        </h3>
                        <div class="flex gap-3">
                            <button onclick="exportAuditLog()" class="btn btn-info no-print">
                                <i class="fas fa-download"></i>تصدير سجل المراجعة
                            </button>
                            <button onclick="clearAuditLog()" class="btn btn-warning no-print">
                                <i class="fas fa-trash-alt"></i>مسح السجل
                            </button>
                        </div>
                    </div>

                    <!-- Security Statistics -->
                    <div class="grid-3 mb-8">
                        <div class="card" style="background: linear-gradient(135deg, #fee2e2, #fecaca);">
                            <h4 class="font-bold text-red-800 mb-2">محاولات دخول فاشلة</h4>
                            <div class="text-3xl font-bold text-red-600" id="failedLogins">0</div>
                            <p class="text-sm text-red-700 mt-2">آخر 24 ساعة</p>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
                            <h4 class="font-bold text-green-800 mb-2">عمليات ناجحة</h4>
                            <div class="text-3xl font-bold text-green-600" id="successfulOperations">0</div>
                            <p class="text-sm text-green-700 mt-2">اليوم</p>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">
                            <h4 class="font-bold text-blue-800 mb-2">المستخدمين النشطين</h4>
                            <div class="text-3xl font-bold text-blue-600" id="activeUsers">1</div>
                            <p class="text-sm text-blue-700 mt-2">حالياً</p>
                        </div>
                    </div>

                    <!-- User Management -->
                    <div class="card mb-8">
                        <h4 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-users-cog ml-2 text-purple-600"></i>إدارة المستخدمين والصلاحيات
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="table compact-table">
                                <thead>
                                    <tr>
                                        <th>اسم المستخدم</th>
                                        <th>الدور</th>
                                        <th>آخر دخول</th>
                                        <th>عدد العمليات</th>
                                        <th>الحالة</th>
                                        <th class="no-print">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    <tr>
                                        <td class="font-medium">admin</td>
                                        <td><span class="status-badge" style="background: #fee2e2; color: #991b1b;">مدير النظام</span></td>
                                        <td>متصل الآن</td>
                                        <td>156</td>
                                        <td><span class="status-badge status-completed">نشط</span></td>
                                        <td class="no-print">
                                            <button class="btn btn-sm btn-warning">تعديل</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="font-medium">accountant</td>
                                        <td><span class="status-badge" style="background: #fef3c7; color: #92400e;">محاسب</span></td>
                                        <td>قبل ساعة</td>
                                        <td>89</td>
                                        <td><span class="status-badge status-completed">نشط</span></td>
                                        <td class="no-print">
                                            <button class="btn btn-sm btn-warning">تعديل</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Audit Log -->
                    <div class="card">
                        <h4 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-clipboard-list ml-2 text-green-600"></i>سجل مراجعة العمليات
                        </h4>
                        <div id="auditLogContainer" style="max-height: 400px; overflow-y: auto;">
                            <!-- Audit logs will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Data Management System with Security
        class TransportationDataManager {
            constructor() {
                this.storageKeys = {
                    items: 'transportation_items',
                    orders: 'transportation_orders',
                    customers: 'transportation_customers',
                    drivers: 'transportation_drivers',
                    accountants: 'transportation_accountants',
                    maintenance: 'transportation_maintenance',
                    payments: 'transportation_payments',
                    settings: 'transportation_settings',
                    orderCounter: 'transportation_order_counter',
                    auditLog: 'transportation_audit_log',
                    users: 'transportation_users'
                };
                this.vatRate = 0.15; // Saudi VAT rate 15%
                this.currentUser = null;
                this.initializeData();
                this.initializeUsers();
            }

            initializeUsers() {
                const users = this.getData(this.storageKeys.users);
                if (users.length === 0) {
                    this.saveData(this.storageKeys.users, [
                        { username: 'admin', password: 'admin123', role: 'admin', name: 'مدير النظام', active: true },
                        { username: 'accountant', password: 'acc123', role: 'accountant', name: 'المحاسب الرئيسي', active: true },
                        { username: 'driver', password: 'drv123', role: 'driver', name: 'السائق', active: true }
                    ]);
                }
            }

            authenticate(username, password) {
                const users = this.getData(this.storageKeys.users);
                const user = users.find(u => u.username === username && u.password === password && u.active);
                if (user) {
                    this.currentUser = user;
                    this.addAuditLog('تسجيل دخول', `تسجيل دخول ناجح للمستخدم ${user.name}`);
                    return user;
                }
                this.addAuditLog('محاولة دخول فاشلة', `محاولة دخول فاشلة للمستخدم ${username}`);
                return null;
            }

            getCurrentUser() {
                return this.currentUser;
            }

            addAuditLog(action, details) {
                const logs = this.getData(this.storageKeys.auditLog);
                const logEntry = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    user: this.currentUser ? this.currentUser.name : 'غير محدد',
                    action: action,
                    details: details,
                    ip: 'localhost' // In real app, get actual IP
                };
                logs.unshift(logEntry);

                // Keep only last 1000 logs
                if (logs.length > 1000) {
                    logs.splice(1000);
                }

                this.saveData(this.storageKeys.auditLog, logs);
            }

            getAuditLogs() {
                return this.getData(this.storageKeys.auditLog);
            }

            initializeData() {
                if (!this.getItems().length) {
                    this.saveData(this.storageKeys.items, this.getSampleItems());
                }
                if (!this.getCustomers().length) {
                    this.saveData(this.storageKeys.customers, this.getSampleCustomers());
                }
                if (!this.getDrivers().length) {
                    this.saveData(this.storageKeys.drivers, this.getSampleDrivers());
                }
                if (!this.getAccountants().length) {
                    this.saveData(this.storageKeys.accountants, this.getSampleAccountants());
                }
                if (!localStorage.getItem(this.storageKeys.orderCounter)) {
                    this.saveOrderCounter(1);
                }
            }

            saveData(key, data) {
                try {
                    const dataWithTimestamp = {
                        data: data,
                        timestamp: new Date().toISOString(),
                        version: '2.0'
                    };
                    localStorage.setItem(key, JSON.stringify(dataWithTimestamp));
                    return true;
                } catch (error) {
                    console.error('Error saving data:', error);
                    showAlert('خطأ في حفظ البيانات. قد تكون مساحة التخزين ممتلئة.', 'error');
                    return false;
                }
            }

            getData(key) {
                try {
                    const stored = localStorage.getItem(key);
                    if (!stored) return [];
                    const parsed = JSON.parse(stored);
                    return parsed.data || parsed;
                } catch (error) {
                    console.error('Error retrieving data:', error);
                    return [];
                }
            }

            // Order Counter Management
            getOrderCounter() {
                try {
                    return parseInt(localStorage.getItem(this.storageKeys.orderCounter)) || 1;
                } catch {
                    return 1;
                }
            }

            saveOrderCounter(counter) {
                localStorage.setItem(this.storageKeys.orderCounter, counter.toString());
            }

            getNextOrderNumber() {
                const current = this.getOrderCounter();
                this.saveOrderCounter(current + 1);
                return current;
            }

            // Items Management
            getItems() {
                return this.getData(this.storageKeys.items);
            }

            addItem(item) {
                const items = this.getItems();
                item.id = Date.now().toString();
                item.createdAt = new Date().toISOString();
                item.sku = item.sku || `SKU-${Date.now()}`;
                items.push(item);
                this.addAuditLog('إضافة صنف', `تم إضافة الصنف: ${item.name}`);
                return this.saveData(this.storageKeys.items, items);
            }

            updateItem(id, updatedItem) {
                const items = this.getItems();
                const index = items.findIndex(item => item.id === id);
                if (index !== -1) {
                    const oldItem = { ...items[index] };
                    items[index] = { ...items[index], ...updatedItem, updatedAt: new Date().toISOString() };
                    this.addAuditLog('تحديث صنف', `تم تحديث الصنف: ${oldItem.name} إلى ${items[index].name}`);
                    return this.saveData(this.storageKeys.items, items);
                }
                return false;
            }

            deleteItem(id) {
                const items = this.getItems();
                const itemToDelete = items.find(item => item.id === id);
                if (itemToDelete) {
                    this.addAuditLog('حذف صنف', `تم حذف الصنف: ${itemToDelete.name}`);
                }
                const filteredItems = items.filter(item => item.id !== id);
                return this.saveData(this.storageKeys.items, filteredItems);
            }

            // Orders Management
            getOrders() {
                return this.getData(this.storageKeys.orders);
            }

            addOrder(order) {
                const orders = this.getOrders();
                order.id = Date.now().toString();
                order.orderNumber = this.getNextOrderNumber();
                order.createdAt = order.orderDateTime || new Date().toISOString();
                order.status = order.status || 'pending';
                order.paymentStatus = order.paymentStatus || 'pending';

                // Calculate VAT
                const subtotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                order.subtotal = subtotal;
                order.vatAmount = subtotal * this.vatRate;
                order.totalAmount = subtotal + order.vatAmount;

                orders.push(order);

                // Update item stock
                const items = this.getItems();
                let stockUpdated = true;
                order.items.forEach(orderedItem => {
                    const itemIndex = items.findIndex(item => item.id === orderedItem.id);
                    if (itemIndex !== -1) {
                        if (items[itemIndex].stock >= orderedItem.quantity) {
                            items[itemIndex].stock -= orderedItem.quantity;
                        } else {
                            showAlert(`المخزون غير كافي للصنف ${orderedItem.name}. لم يتم إنشاء الطلب.`, 'error');
                            stockUpdated = false;
                        }
                    }
                });

                if (stockUpdated) {
                    this.saveData(this.storageKeys.items, items);
                    this.addAuditLog('إنشاء طلب', `تم إنشاء الطلب رقم ط-${order.orderNumber}`);
                    return this.saveData(this.storageKeys.orders, orders);
                }
                return false;
            }

            updateOrderStatus(id, status) {
                const orders = this.getOrders();
                const index = orders.findIndex(order => order.id === id);
                if (index !== -1) {
                    const oldStatus = orders[index].status;
                    orders[index].status = status;
                    orders[index].updatedAt = new Date().toISOString();
                    this.addAuditLog('تحديث حالة طلب', `تم تحديث حالة الطلب ط-${orders[index].orderNumber} من ${oldStatus} إلى ${status}`);
                    return this.saveData(this.storageKeys.orders, orders);
                }
                return false;
            }

            updateOrderPaymentStatus(id, paymentStatus) {
                const orders = this.getOrders();
                const index = orders.findIndex(order => order.id === id);
                if (index !== -1) {
                    const oldStatus = orders[index].paymentStatus;
                    orders[index].paymentStatus = paymentStatus;
                    orders[index].updatedAt = new Date().toISOString();
                    this.addAuditLog('تحديث حالة دفع', `تم تحديث حالة دفع الطلب ط-${orders[index].orderNumber} من ${oldStatus} إلى ${paymentStatus}`);
                    return this.saveData(this.storageKeys.orders, orders);
                }
                return false;
            }

            deleteOrder(id) {
                const orders = this.getOrders();
                const orderToDelete = orders.find(order => order.id === id);

                if (orderToDelete) {
                    // Return stock
                    const items = this.getItems();
                    orderToDelete.items.forEach(orderedItem => {
                        const itemIndex = items.findIndex(item => item.id === orderedItem.id);
                        if (itemIndex !== -1) {
                            items[itemIndex].stock += orderedItem.quantity;
                        }
                    });
                    this.saveData(this.storageKeys.items, items);
                    this.addAuditLog('حذف طلب', `تم حذف الطلب ط-${orderToDelete.orderNumber}`);
                }

                const updatedOrders = orders.filter(order => order.id !== id);
                return this.saveData(this.storageKeys.orders, updatedOrders);
            }

            // Customers Management
            getCustomers() {
                return this.getData(this.storageKeys.customers);
            }

            addCustomer(customer) {
                const customers = this.getCustomers();
                customer.id = Date.now().toString();
                customer.createdAt = customer.joinDate || new Date().toISOString();
                customer.totalOrders = 0;
                customer.totalSpent = 0;
                customer.segment = customer.segment || 'cold';
                customers.push(customer);
                this.addAuditLog('إضافة عميل', `تم إضافة العميل: ${customer.name}`);
                return this.saveData(this.storageKeys.customers, customers);
            }

            updateCustomer(id, updatedCustomer) {
                const customers = this.getCustomers();
                const index = customers.findIndex(customer => customer.id === id);
                if (index !== -1) {
                    const oldCustomer = { ...customers[index] };
                    customers[index] = { ...customers[index], ...updatedCustomer, updatedAt: new Date().toISOString() };
                    this.addAuditLog('تحديث عميل', `تم تحديث بيانات العميل: ${oldCustomer.name}`);
                    return this.saveData(this.storageKeys.customers, customers);
                }
                return false;
            }

            deleteCustomer(id) {
                const customers = this.getCustomers();
                const customerToDelete = customers.find(customer => customer.id === id);
                if (customerToDelete) {
                    this.addAuditLog('حذف عميل', `تم حذف العميل: ${customerToDelete.name}`);
                }
                const filteredCustomers = customers.filter(customer => customer.id !== id);
                return this.saveData(this.storageKeys.customers, filteredCustomers);
            }

            // Drivers Management
            getDrivers() {
                return this.getData(this.storageKeys.drivers);
            }

            addDriver(driver) {
                const drivers = this.getDrivers();
                driver.id = Date.now().toString();
                driver.createdAt = driver.hireDate || new Date().toISOString();
                driver.active = true;
                driver.totalTrips = 0;
                driver.totalEarnings = 0;
                driver.rating = driver.rating || 5;
                drivers.push(driver);
                this.addAuditLog('إضافة سائق', `تم إضافة السائق: ${driver.name}`);
                return this.saveData(this.storageKeys.drivers, drivers);
            }

            updateDriver(id, updatedDriver) {
                const drivers = this.getDrivers();
                const index = drivers.findIndex(driver => driver.id === id);
                if (index !== -1) {
                    const oldDriver = { ...drivers[index] };
                    drivers[index] = { ...drivers[index], ...updatedDriver, updatedAt: new Date().toISOString() };
                    this.addAuditLog('تحديث سائق', `تم تحديث بيانات السائق: ${oldDriver.name}`);
                    return this.saveData(this.storageKeys.drivers, drivers);
                }
                return false;
            }

            deleteDriver(id) {
                const drivers = this.getDrivers();
                const driverToDelete = drivers.find(driver => driver.id === id);
                if (driverToDelete) {
                    this.addAuditLog('حذف سائق', `تم حذف السائق: ${driverToDelete.name}`);
                }
                const filteredDrivers = drivers.filter(driver => driver.id !== id);
                return this.saveData(this.storageKeys.drivers, filteredDrivers);
            }

            // Accountants Management
            getAccountants() {
                return this.getData(this.storageKeys.accountants);
            }

            addAccountant(accountant) {
                const accountants = this.getAccountants();
                accountant.id = Date.now().toString();
                accountant.createdAt = accountant.hireDate || new Date().toISOString();
                accountant.active = true;
                accountant.totalOrdersProcessed = 0;
                accountants.push(accountant);
                this.addAuditLog('إضافة محاسب', `تم إضافة المحاسب: ${accountant.name}`);
                return this.saveData(this.storageKeys.accountants, accountants);
            }

            updateAccountant(id, updatedAccountant) {
                const accountants = this.getAccountants();
                const index = accountants.findIndex(accountant => accountant.id === id);
                if (index !== -1) {
                    const oldAccountant = { ...accountants[index] };
                    accountants[index] = { ...accountants[index], ...updatedAccountant, updatedAt: new Date().toISOString() };
                    this.addAuditLog('تحديث محاسب', `تم تحديث بيانات المحاسب: ${oldAccountant.name}`);
                    return this.saveData(this.storageKeys.accountants, accountants);
                }
                return false;
            }

            deleteAccountant(id) {
                const accountants = this.getAccountants();
                const accountantToDelete = accountants.find(accountant => accountant.id === id);
                if (accountantToDelete) {
                    this.addAuditLog('حذف محاسب', `تم حذف المحاسب: ${accountantToDelete.name}`);
                }
                const filteredAccountants = accountants.filter(accountant => accountant.id !== id);
                return this.saveData(this.storageKeys.accountants, filteredAccountants);
            }

            // Maintenance Management
            getMaintenanceRecords() {
                return this.getData(this.storageKeys.maintenance);
            }

            addMaintenanceRecord(maintenance) {
                const records = this.getMaintenanceRecords();
                maintenance.id = Date.now().toString();
                maintenance.createdAt = new Date().toISOString();
                records.push(maintenance);
                this.addAuditLog('إضافة سجل صيانة', `تم إضافة سجل صيانة للمركبة: ${maintenance.vehicleId}`);
                return this.saveData(this.storageKeys.maintenance, records);
            }

            updateMaintenanceRecord(id, updatedRecord) {
                const records = this.getMaintenanceRecords();
                const index = records.findIndex(record => record.id === id);
                if (index !== -1) {
                    records[index] = { ...records[index], ...updatedRecord, updatedAt: new Date().toISOString() };
                    this.addAuditLog('تحديث سجل صيانة', `تم تحديث سجل الصيانة رقم: ${id}`);
                    return this.saveData(this.storageKeys.maintenance, records);
                }
                return false;
            }

            deleteMaintenanceRecord(id) {
                const records = this.getMaintenanceRecords();
                const recordToDelete = records.find(record => record.id === id);
                if (recordToDelete) {
                    this.addAuditLog('حذف سجل صيانة', `تم حذف سجل الصيانة رقم: ${id}`);
                }
                const filteredRecords = records.filter(record => record.id !== id);
                return this.saveData(this.storageKeys.maintenance, filteredRecords);
            }

            // Payment Management
            getPayments() {
                return this.getData(this.storageKeys.payments);
            }

            addPayment(payment) {
                const payments = this.getPayments();
                payment.id = Date.now().toString();
                payment.createdAt = new Date().toISOString();
                payment.status = payment.status || 'completed';
                payments.push(payment);
                this.addAuditLog('إضافة دفعة', `تم تسجيل دفعة بمبلغ ${payment.amount} للطلب ${payment.orderId}`);
                return this.saveData(this.storageKeys.payments, payments);
            }

            // Export/Import
            exportAllData() {
                const exportData = {
                    items: this.getItems(),
                    orders: this.getOrders(),
                    customers: this.getCustomers(),
                    drivers: this.getDrivers(),
                    accountants: this.getAccountants(),
                    maintenance: this.getMaintenanceRecords(),
                    payments: this.getPayments(),
                    orderCounter: this.getOrderCounter(),
                    auditLog: this.getAuditLogs(),
                    exportDate: new Date().toISOString(),
                    version: '2.0'
                };
                this.addAuditLog('تصدير البيانات', 'تم تصدير جميع بيانات النظام');
                return JSON.stringify(exportData, null, 2);
            }

            importAllData(jsonData) {
                try {
                    const data = JSON.parse(jsonData);
                    if (data.items) this.saveData(this.storageKeys.items, data.items);
                    if (data.orders) this.saveData(this.storageKeys.orders, data.orders);
                    if (data.customers) this.saveData(this.storageKeys.customers, data.customers);
                    if (data.drivers) this.saveData(this.storageKeys.drivers, data.drivers);
                    if (data.accountants) this.saveData(this.storageKeys.accountants, data.accountants);
                    if (data.maintenance) this.saveData(this.storageKeys.maintenance, data.maintenance);
                    if (data.payments) this.saveData(this.storageKeys.payments, data.payments);
                    if (data.orderCounter) this.saveOrderCounter(data.orderCounter);
                    this.addAuditLog('استيراد البيانات', 'تم استيراد البيانات بنجاح');
                    return true;
                } catch (error) {
                    console.error('Error importing data:', error);
                    this.addAuditLog('خطأ في الاستيراد', `فشل في استيراد البيانات: ${error.message}`);
                    return false;
                }
            }

            clearAllData() {
                Object.values(this.storageKeys).forEach(key => {
                    localStorage.removeItem(key);
                });
                this.addAuditLog('مسح البيانات', 'تم مسح جميع بيانات النظام');
                this.initializeData();
            }

            // Sample Data
            getSampleItems() {
                return [
                    {
                        id: '1',
                        name: 'بلوك أسمنتي عالي الجودة',
                        price: 2.50,
                        category: 'مواد-بناء',
                        description: 'بلوك أسمنتي عالي الجودة مقاوم للرطوبة',
                        stock: 1000,
                        minStock: 100,
                        unit: 'قطعة',
                        location: 'مخزن A - رف 1',
                        sku: 'BLK-001',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: '2',
                        name: 'قمح درجة أولى',
                        price: 1200,
                        category: 'مواد-غذائية',
                        description: 'قمح درجة أولى مطابق للمواصفات',
                        stock: 50,
                        minStock: 10,
                        unit: 'طن',
                        location: 'مخزن B - صومعة 1',
                        sku: 'WHT-001',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: '3',
                        name: 'أسمنت بورتلاندي',
                        price: 25,
                        category: 'مواد-بناء',
                        description: 'أسمنت بورتلاندي عادي 42.5',
                        stock: 200,
                        minStock: 50,
                        unit: 'كيس',
                        location: 'مخزن A - رف 2',
                        sku: 'CEM-001',
                        createdAt: new Date().toISOString()
                    }
                ];
            }

            getSampleCustomers() {
                return [
                    {
                        id: '1',
                        name: 'شركة البناء المتطور المحدودة',
                        phone: '0501234567',
                        email: 'info@building.com',
                        address: 'الرياض، حي العليا، شارع الملك فهد',
                        taxNumber: '123456789012345',
                        type: 'company',
                        segment: 'hot',
                        source: 'referral',
                        creditLimit: 100000,
                        notes: 'عميل مميز مع سجل دفع ممتاز',
                        totalOrders: 0,
                        totalSpent: 0,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: '2',
                        name: 'محمد أحمد العبدالله',
                        phone: '0501234568',
                        email: 'mohamed@gmail.com',
                        address: 'جدة، حي الصفا',
                        type: 'individual',
                        segment: 'warm',
                        source: 'website',
                        creditLimit: 25000,
                        notes: 'عميل جديد محتمل',
                        totalOrders: 0,
                        totalSpent: 0,
                        createdAt: new Date().toISOString()
                    }
                ];
            }

            getSampleDrivers() {
                return [
                    {
                        id: '1',
                        name: 'أحمد محمد العلي',
                        phone: '0501234568',
                        idNumber: '1234567890',
                        license: 'LIC123456',
                        licenseExpiry: '2025-12-31',
                        carId: 'ABC-1234',
                        carType: 'شاحنة-متوسطة',
                        active: true,
                        employmentStatus: 'full-time',
                        salary: 5000,
                        rating: 5,
                        totalTrips: 0,
                        totalEarnings: 0,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: '2',
                        name: 'علي سعد المطيري',
                        phone: '0501234569',
                        idNumber: '9876543210',
                        license: 'LIC654321',
                        licenseExpiry: '2024-06-30',
                        carId: 'XYZ-5678',
                        carType: 'شاحنة-كبيرة',
                        active: true,
                        employmentStatus: 'full-time',
                        salary: 6000,
                        rating: 4,
                        totalTrips: 0,
                        totalEarnings: 0,
                        createdAt: new Date().toISOString()
                    }
                ];
            }

            getSampleAccountants() {
                return [
                    {
                        id: '1',
                        name: 'سارة أحمد الزهراني',
                        phone: '0501234569',
                        email: 'sara@transport.com',
                        employeeId: 'ACC001',
                        position: 'محاسب أول',
                        accessLevel: 'advanced',
                        salary: 8000,
                        active: true,
                        totalOrdersProcessed: 0,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: '2',
                        name: 'خالد عبدالعزيز النمر',
                        phone: '0501234570',
                        email: 'khalid@transport.com',
                        employeeId: 'ACC002',
                        position: 'مدير مالي',
                        accessLevel: 'manager',
                        salary: 12000,
                        active: true,
                        totalOrdersProcessed: 0,
                        createdAt: new Date().toISOString()
                    }
                ];
            }
        }

        // Initialize Data Manager and Global Variables
        const dataManager = new TransportationDataManager();
        let currentCurrency = 'ر.س';

        // Chart instances to destroy before re-rendering
        let salesChartInstance = null;
        let popularItemsChartInstance = null;
        let monthlyRevenueChartInstance = null;
        let orderStatusChartInstance = null;
        let categoryPerformanceChartInstance = null;
        let driversPerformanceChartInstance = null;

        // Authentication Functions
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                showAlert('يرجى إدخال اسم المستخدم وكلمة المرور', 'error');
                return;
            }

            const user = dataManager.authenticate(username, password);
            if (user) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('currentUser').textContent = user.name;

                // Show/hide tabs based on user role
                setupUserInterface(user.role);

                showAlert(`مرحباً ${user.name}، تم تسجيل الدخول بنجاح`, 'success');
                showTab('dashboard');
                showSmartNotification('تسجيل دخول ناجح', `مرحباً ${user.name}`);
            } else {
                showAlert('بيانات الدخول غير صحيحة', 'error');
            }
        }

        function logout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                dataManager.addAuditLog('تسجيل خروج', `تم تسجيل الخروج للمستخدم ${dataManager.getCurrentUser().name}`);
                dataManager.currentUser = null;
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
            }
        }

        function setupUserInterface(role) {
            // Hide all tabs initially
            const restrictedTabs = ['itemsTab', 'ordersTab', 'driversTab', 'accountantsTab', 'securityTab'];

            restrictedTabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    if (role === 'admin') {
                        tab.style.display = 'block';
                    } else if (role === 'accountant') {
                        if (['itemsTab', 'ordersTab', 'accountantsTab'].includes(tabId)) {
                            tab.style.display = 'block';
                        } else {
                            tab.style.display = 'none';
                        }
                    } else if (role === 'driver') {
                        if (tabId === 'ordersTab') { // Drivers can only see orders
                            tab.style.display = 'block';
                        } else {
                            tab.style.display = 'none';
                        }
                    } else {
                        tab.style.display = 'none'; // Default hide for unknown roles
                    }
                }
            });

            // Specific elements visibility based on role
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            const accountantOnlyElements = document.querySelectorAll('.accountant-only');
            const driverOnlyElements = document.querySelectorAll('.driver-only');

            adminOnlyElements.forEach(el => el.style.display = (role === 'admin' ? 'block' : 'none'));
            accountantOnlyElements.forEach(el => el.style.display = (role === 'accountant' ? 'block' : 'none'));
            driverOnlyElements.forEach(el => el.style.display = (role === 'driver' ? 'block' : 'none'));

            // Adjust button visibility for non-admin roles
            if (role !== 'admin') {
                document.querySelectorAll('.no-print').forEach(btn => {
                    if (!btn.classList.contains('btn-primary') && !btn.classList.contains('btn-success') && !btn.classList.contains('btn-info') && !btn.classList.contains('btn-warning')) {
                        // Keep export/import/logout buttons visible for all roles
                    } else if (btn.textContent.includes('إضافة') || btn.textContent.includes('تعديل') || btn.textContent.includes('حذف') || btn.textContent.includes('مسح')) {
                        btn.style.display = 'none';
                    }
                });
            }
        }

        // Global UI Functions
        function showTab(tabId) {
            const sections = document.querySelectorAll('.section-container');
            sections.forEach(section => section.classList.add('hidden'));

            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            document.getElementById(tabId).classList.remove('hidden');
            document.querySelector(`.nav-tab[onclick="showTab('${tabId}')"]`).classList.add('active');

            // Refresh data and charts when switching tabs
            if (tabId === 'dashboard') {
                updateDashboardStats();
                renderSalesChart();
                renderPopularItemsChart();
                checkSmartAlerts();
                renderRecentOrders();
            } else if (tabId === 'items') {
                renderItemsList();
            } else if (tabId === 'orders') {
                renderOrdersTable();
                populateOrderForms();
            } else if (tabId === 'customers') {
                renderCustomersList();
                updateCRMCards();
            } else if (tabId === 'drivers') {
                renderDriversList();
            } else if (tabId === 'maintenance') {
                renderMaintenanceTable();
                populateMaintenanceVehicleSelect();
                checkScheduledMaintenance();
            } else if (tabId === 'accountants') {
                renderAccountantsList();
            } else if (tabId === 'payments') {
                renderPaymentsTable();
                populatePaymentOrderSelect();
                updatePaymentStats();
            } else if (tabId === 'analytics') {
                renderMonthlyRevenueChart();
                renderOrderStatusChart();
                renderCategoryPerformanceChart();
                renderDriversPerformanceChart();
                renderStockLevelsTable();
                updateVATSummary();
                updateProfitabilityAnalysis();
            } else if (tabId === 'security') {
                renderAuditLog();
                updateSecurityStats();
                renderUsersTable();
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} flex items-center`;
            alertDiv.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'} ml-2"></i><span>${message}</span>`;
            alertContainer.prepend(alertDiv); // Add to top

            setTimeout(() => {
                alertDiv.remove();
            }, 5000); // Remove after 5 seconds
        }

        function showSmartNotification(title, message) {
            const notificationContainer = document.getElementById('notificationContainer');
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'notification';
            notificationDiv.innerHTML = `
                    <div class="font-bold text-lg">${title}</div>
                    <p class="text-sm">${message}</p>
                `;
            notificationContainer.appendChild(notificationDiv);

            setTimeout(() => {
                notificationDiv.remove();
            }, 7000); // Remove after 7 seconds
        }

        function formatCurrency(amount) {
            return `${amount.toFixed(2)} ${currentCurrency}`;
        }

        function changeCurrency() {
            currentCurrency = document.getElementById('currencySelect').value;
            // Re-render all tables and charts to reflect new currency
            showTab(document.querySelector('.nav-tab.active').getAttribute('onclick').match(/'([^']+)'/)[1]);
        }

        function globalSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sections = document.querySelectorAll('.section-container:not(.hidden)'); // Search only in active tab
            sections.forEach(section => {
                const rows = section.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const textContent = row.textContent.toLowerCase();
                    if (textContent.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        // Dashboard Functions
        function updateDashboardStats() {
            const orders = dataManager.getOrders();
            const customers = dataManager.getCustomers();
            const drivers = dataManager.getDrivers();
            const items = dataManager.getItems();

            const today = new Date().toISOString().split('T')[0];
            const totalOrdersToday = orders.filter(order => order.createdAt.startsWith(today)).length;
            const totalRevenue = orders.reduce((sum, order) => sum + order.totalAmount, 0);
            const activeDrivers = drivers.filter(driver => driver.active).length;

            document.getElementById('totalOrders').textContent = totalOrdersToday;
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalCustomers').textContent = customers.length;
            document.getElementById('totalDrivers').textContent = activeDrivers;
            document.getElementById('totalItems').textContent = items.length;
        }

        function renderSalesChart() {
            if (salesChartInstance) salesChartInstance.destroy();
            const ctx = document.getElementById('salesChart').getContext('2d');
            const orders = dataManager.getOrders();

            const monthlySales = {};
            orders.forEach(order => {
                const month = new Date(order.createdAt).toLocaleString('ar', { month: 'short', year: 'numeric' });
                monthlySales[month] = (monthlySales[month] || 0) + order.totalAmount;
            });

            const labels = Object.keys(monthlySales).sort((a, b) => new Date(a) - new Date(b));
            const data = labels.map(label => monthlySales[label]);

            salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'الإيرادات الشهرية',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        function renderPopularItemsChart() {
            if (popularItemsChartInstance) popularItemsChartInstance.destroy();
            const ctx = document.getElementById('popularItemsChart').getContext('2d');
            const orders = dataManager.getOrders();
            const items = dataManager.getItems();

            const itemSales = {};
            orders.forEach(order => {
                order.items.forEach(orderedItem => {
                    const item = items.find(i => i.id === orderedItem.id);
                    if (item) {
                        itemSales[item.name] = (itemSales[item.name] || 0) + orderedItem.quantity;
                    }
                });
            });

            const sortedItems = Object.entries(itemSales).sort(([, a], [, b]) => b - a).slice(0, 5); // Top 5
            const labels = sortedItems.map(([name]) => name);
            const data = sortedItems.map(([, quantity]) => quantity);

            popularItemsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'الكمية المباعة',
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function checkSmartAlerts() {
            const smartAlertsDiv = document.getElementById('smartAlerts');
            smartAlertsDiv.innerHTML = ''; // Clear previous alerts

            const items = dataManager.getItems();
            const lowStockItems = items.filter(item => item.stock <= item.minStock);
            if (lowStockItems.length > 0) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-error';
                alertDiv.innerHTML = `<i class="fas fa-warehouse ml-2"></i>انخفاض مخزون في ${lowStockItems.length} من الأصناف.`;
                smartAlertsDiv.appendChild(alertDiv);
                showSmartNotification('تنبيه مخزون', `يوجد ${lowStockItems.length} صنف بمخزون منخفض!`);
            }

            const drivers = dataManager.getDrivers();
            const expiringLicenses = drivers.filter(driver => {
                if (!driver.licenseExpiry) return false;
                const expiryDate = new Date(driver.licenseExpiry);
                const today = new Date();
                const diffTime = expiryDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 60 && diffDays >= 0; // Expiring within 60 days
            });
            if (expiringLicenses.length > 0) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning';
                alertDiv.innerHTML = `<i class="fas fa-id-card ml-2"></i>يوجد ${expiringLicenses.length} رخصة قيادة على وشك الانتهاء.`;
                smartAlertsDiv.appendChild(alertDiv);
                showSmartNotification('تنبيه رخص', `يوجد ${expiringLicenses.length} رخصة قيادة على وشك الانتهاء!`);
            }

            const maintenanceRecords = dataManager.getMaintenanceRecords();
            const vehiclesNeedingMaintenance = maintenanceRecords.filter(record => {
                if (!record.maintenanceNextMileage) return false;
                const driver = dataManager.getDrivers().find(d => d.carId === record.vehicleId);
                if (!driver) return false; // Vehicle not assigned to an active driver
                // This is a simplified check. In a real system, you'd track current mileage.
                // For demo, we'll assume if next mileage is set, it needs attention.
                return true; // Placeholder for actual logic
            }).length;

            if (vehiclesNeedingMaintenance > 0) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning';
                alertDiv.innerHTML = `<i class="fas fa-tools ml-2"></i>يوجد ${vehiclesNeedingMaintenance} مركبة تحتاج صيانة دورية.`;
                smartAlertsDiv.appendChild(alertDiv);
                showSmartNotification('تنبيه صيانة', `يوجد ${vehiclesNeedingMaintenance} مركبة تحتاج صيانة!`);
            }

            if (smartAlertsDiv.innerHTML === '') {
                smartAlertsDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle ml-2"></i>لا توجد تنبيهات حالياً.</div>';
            }
        }

        function renderRecentOrders() {
            const ordersTableBody = document.getElementById('recentOrdersTable');
            ordersTableBody.innerHTML = '';
            const orders = dataManager.getOrders().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5); // Last 5 orders

            const customers = dataManager.getCustomers();
            const accountants = dataManager.getAccountants();
            const drivers = dataManager.getDrivers();

            orders.forEach(order => {
                const customer = customers.find(c => c.id === order.customer);
                const accountant = accountants.find(a => a.id === order.accountant);
                const driver = drivers.find(d => d.id === order.driver);

                const row = ordersTableBody.insertRow();
                row.innerHTML = `
                        <td>ط-${order.orderNumber}</td>
                        <td>${customer ? customer.name : 'غير معروف'}</td>
                        <td>${accountant ? accountant.name : 'غير معروف'}</td>
                        <td>${driver ? driver.name : 'غير معروف'}</td>
                        <td>${order.fromLocation}</td>
                        <td>${order.toLocation}</td>
                        <td>${formatCurrency(order.subtotal)}</td>
                        <td>${formatCurrency(order.vatAmount)}</td>
                        <td>${formatCurrency(order.totalAmount)}</td>
                        <td><span class="status-badge status-${order.paymentStatus === 'completed' ? 'completed' : 'pending'}">${order.paymentStatus === 'completed' ? 'مدفوع' : 'معلق'}</span></td>
                        <td><span class="status-badge status-${order.status === 'completed' ? 'completed' : order.status === 'in-progress' ? 'in-progress' : 'pending'}">${order.status === 'pending' ? 'قيد الانتظار' : order.status === 'in-progress' ? 'قيد التنفيذ' : order.status === 'completed' ? 'مكتمل' : 'ملغى'}</span></td>
                        <td>${new Date(order.createdAt).toLocaleDateString('ar-SA')}</td>
                    `;
            });
        }

        // Items Management Functions
        function renderItemsList() {
            const itemsListDiv = document.getElementById('itemsList');
            itemsListDiv.innerHTML = '';
            const items = dataManager.getItems();

            if (items.length === 0) {
                itemsListDiv.innerHTML = '<p class="text-gray-600 text-center py-8">لا توجد أصناف مسجلة حالياً. ابدأ بإضافة صنف جديد.</p>';
                return;
            }

            items.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                itemCard.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-lg text-gray-800">${item.name}</h4>
                            <span class="text-sm text-gray-500">SKU: ${item.sku}</span>
                        </div>
                        <p class="text-gray-700 mb-2">${item.description}</p>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-4">
                            <div><strong>السعر:</strong> ${formatCurrency(item.price)} / ${item.unit}</div>
                            <div><strong>المخزون:</strong> ${item.stock} ${item.unit} ${item.stock <= item.minStock ? '<span class="low-stock">(مخزون منخفض!)</span>' : ''}</div>
                            <div><strong>الفئة:</strong> ${item.category}</div>
                            <div><strong>الموقع:</strong> ${item.location}</div>
                        </div>
                        <div class="flex gap-2 justify-end no-print">
                            <button onclick="editItem('${item.id}')" class="btn btn-sm btn-warning"><i class="fas fa-edit"></i>تعديل</button>
                            <button onclick="deleteItem('${item.id}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i>حذف</button>
                            <button onclick="generateQRForItem('${item.id}', '${item.name}', '${item.sku}')" class="btn btn-sm btn-info"><i class="fas fa-qrcode"></i>QR</button>
                        </div>
                    `;
                itemsListDiv.appendChild(itemCard);
            });
        }

        function showAddItemForm() {
            document.getElementById('addItemForm').classList.remove('hidden');
            // Clear form fields
            document.getElementById('itemName').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemStock').value = '';
            document.getElementById('itemUnit').value = '';
            document.getElementById('itemMinStock').value = '';
            document.getElementById('itemLocation').value = '';
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemDescription').value = '';
            document.getElementById('itemSKU').value = '';
        }

        function hideAddItemForm() {
            document.getElementById('addItemForm').classList.add('hidden');
        }

        function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const price = parseFloat(document.getElementById('itemPrice').value);
            const stock = parseInt(document.getElementById('itemStock').value);
            const unit = document.getElementById('itemUnit').value;
            const minStock = parseInt(document.getElementById('itemMinStock').value) || 0;
            const location = document.getElementById('itemLocation').value.trim();
            const category = document.getElementById('itemCategory').value;
            const description = document.getElementById('itemDescription').value.trim();
            const sku = document.getElementById('itemSKU').value.trim();

            if (!name || isNaN(price) || isNaN(stock) || !unit) {
                showAlert('يرجى ملء جميع الحقول المطلوبة (اسم الصنف، السعر، الكمية، الوحدة).', 'error');
                return;
            }

            const newItem = { name, price, stock, unit, minStock, location, category, description, sku };
            if (dataManager.addItem(newItem)) {
                showAlert('تم إضافة الصنف بنجاح!', 'success');
                hideAddItemForm();
                renderItemsList();
                updateDashboardStats();
                checkSmartAlerts();
            } else {
                showAlert('فشل إضافة الصنف.', 'error');
            }
        }

        function editItem(id) {
            const items = dataManager.getItems();
            const item = items.find(i => i.id === id);
            if (item) {
                showAddItemForm(); // Reuse the add form for editing
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemPrice').value = item.price;
                document.getElementById('itemStock').value = item.stock;
                document.getElementById('itemUnit').value = item.unit;
                document.getElementById('itemMinStock').value = item.minStock;
                document.getElementById('itemLocation').value = item.location;
                document.getElementById('itemCategory').value = item.category;
                document.getElementById('itemDescription').value = item.description;
                document.getElementById('itemSKU').value = item.sku;

                // Change button to update
                const addButton = document.querySelector('#addItemForm .btn-success');
                addButton.textContent = 'تحديث الصنف';
                addButton.onclick = () => updateItem(id);
            }
        }

        function updateItem(id) {
            const name = document.getElementById('itemName').value.trim();
            const price = parseFloat(document.getElementById('itemPrice').value);
            const stock = parseInt(document.getElementById('itemStock').value);
            const unit = document.getElementById('itemUnit').value;
            const minStock = parseInt(document.getElementById('itemMinStock').value) || 0;
            const location = document.getElementById('itemLocation').value.trim();
            const category = document.getElementById('itemCategory').value;
            const description = document.getElementById('itemDescription').value.trim();
            const sku = document.getElementById('itemSKU').value.trim();

            if (!name || isNaN(price) || isNaN(stock) || !unit) {
                showAlert('يرجى ملء جميع الحقول المطلوبة (اسم الصنف، السعر، الكمية، الوحدة).', 'error');
                return;
            }

            const updatedItem = { name, price, stock, unit, minStock, location, category, description, sku };
            if (dataManager.updateItem(id, updatedItem)) {
                showAlert('تم تحديث الصنف بنجاح!', 'success');
                hideAddItemForm();
                renderItemsList();
                updateDashboardStats();
                checkSmartAlerts();
                // Reset button
                const addButton = document.querySelector('#addItemForm .btn-success');
                addButton.textContent = 'إضافة الصنف';
                addButton.onclick = addItem;
            } else {
                showAlert('فشل تحديث الصنف.', 'error');
            }
        }

        function deleteItem(id) {
            if (confirm('هل أنت متأكد من حذف هذا الصنف؟')) {
                if (dataManager.deleteItem(id)) {
                    showAlert('تم حذف الصنف بنجاح!', 'success');
                    renderItemsList();
                    updateDashboardStats();
                    checkSmartAlerts();
                } else {
                    showAlert('فشل حذف الصنف.', 'error');
                }
            }
        }

        function generateQRForItem(itemId, itemName, itemSku) {
            const qrCodeContainer = document.createElement('div');
            qrCodeContainer.className = 'qr-code-container';
            qrCodeContainer.innerHTML = `
                    <h4 class="text-lg font-semibold mb-4">رمز QR للصنف: ${itemName}</h4>
                    <div id="qrCodeCanvas_${itemId}" class="mx-auto w-48 h-48"></div>
                    <p class="text-sm text-gray-600 mt-2">SKU: ${itemSku}</p>
                    <button onclick="this.parentNode.remove()" class="btn btn-sm btn-danger mt-4 no-print">إغلاق</button>
                `;
            document.getElementById('items').appendChild(qrCodeContainer);

            const qrData = JSON.stringify({ id: itemId, name: itemName, sku: itemSku });
            new QRCode(document.getElementById(`qrCodeCanvas_${itemId}`), {
                text: qrData,
                width: 192,
                height: 192,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function generateQRForAllItems() {
            const items = dataManager.getItems();
            if (items.length === 0) {
                showAlert('لا توجد أصناف لتوليد رموز QR لها.', 'warning');
                return;
            }

            const qrContainer = document.createElement('div');
            qrContainer.className = 'card mt-6';
            qrContainer.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">رموز QR لجميع الأصناف</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="allItemQRs"></div>
                    <button onclick="this.parentNode.remove()" class="btn btn-danger mt-6 no-print">إغلاق</button>
                `;
            document.getElementById('items').appendChild(qrContainer);
            const allItemQRsDiv = document.getElementById('allItemQRs');

            items.forEach(item => {
                const itemQrDiv = document.createElement('div');
                itemQrDiv.className = 'text-center p-4 border rounded-lg';
                itemQrDiv.innerHTML = `
                        <h5 class="font-semibold mb-2">${item.name}</h5>
                        <div id="qrCodeCanvas_all_${item.id}" class="mx-auto w-32 h-32"></div>
                        <p class="text-xs text-gray-500 mt-1">SKU: ${item.sku}</p>
                    `;
                allItemQRsDiv.appendChild(itemQrDiv);

                const qrData = JSON.stringify({ id: item.id, name: item.name, sku: item.sku });
                new QRCode(document.getElementById(`qrCodeCanvas_all_${item.id}`), {
                    text: qrData,
                    width: 128,
                    height: 128,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            });
            showAlert('تم توليد رموز QR لجميع الأصناف.', 'success');
        }

        // Orders Management Functions
        function renderOrdersTable() {
            const ordersTableBody = document.getElementById('ordersTable');
            ordersTableBody.innerHTML = '';
            const orders = dataManager.getOrders().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const customers = dataManager.getCustomers();
            const accountants = dataManager.getAccountants();
            const drivers = dataManager.getDrivers();
            const items = dataManager.getItems();

            orders.forEach(order => {
                const customer = customers.find(c => c.id === order.customer);
                const accountant = accountants.find(a => a.id === order.accountant);
                const driver = drivers.find(d => d.id === order.driver);

                const row = ordersTableBody.insertRow();
                row.innerHTML = `
                        <td>ط-${order.orderNumber}</td>
                        <td>${customer ? customer.name : 'غير معروف'}</td>
                        <td>${accountant ? accountant.name : 'غير معروف'}</td>
                        <td>${driver ? driver.name : 'غير معروف'}</td>
                        <td>${order.fromLocation}</td>
                        <td>${order.toLocation}</td>
                        <td>${formatCurrency(order.subtotal)}</td>
                        <td>${formatCurrency(order.vatAmount)}</td>
                        <td>${formatCurrency(order.totalAmount)}</td>
                        <td>${order.paymentMethod}</td>
                        <td><span class="status-badge status-${order.paymentStatus === 'completed' ? 'completed' : 'pending'}">${order.paymentStatus === 'completed' ? 'مدفوع' : 'معلق'}</span></td>
                        <td><span class="status-badge status-${order.status === 'completed' ? 'completed' : order.status === 'in-progress' ? 'in-progress' : 'pending'}">${order.status === 'pending' ? 'قيد الانتظار' : order.status === 'in-progress' ? 'قيد التنفيذ' : order.status === 'completed' ? 'مكتمل' : 'ملغى'}</span></td>
                        <td>${order.priority}</td>
                        <td>${new Date(order.createdAt).toLocaleDateString('ar-SA')}</td>
                        <td class="no-print">
                            <button onclick="viewOrderDetails('${order.id}')" class="btn btn-sm btn-info"><i class="fas fa-eye"></i>عرض</button>
                            <button onclick="editOrder('${order.id}')" class="btn btn-sm btn-warning"><i class="fas fa-edit"></i>تعديل</button>
                            <button onclick="deleteOrder('${order.id}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i>حذف</button>
                        </td>
                    `;
            });
        }

        function showCreateOrderForm() {
            document.getElementById('createOrderForm').classList.remove('hidden');
            // Clear form fields
            document.getElementById('orderCustomer').value = '';
            document.getElementById('orderAccountant').value = '';
            document.getElementById('orderDriver').value = '';
            document.getElementById('orderPriority').value = 'normal';
            document.getElementById('orderFromLocation').value = '';
            document.getElementById('orderToLocation').value = '';
            document.getElementById('orderDateTime').value = '';
            document.getElementById('orderDistance').value = '';
            document.getElementById('orderPaymentMethod').value = 'cash';
            document.getElementById('orderNotes').value = '';
            document.getElementById('orderItemsContainer').innerHTML = ''; // Clear items
            addOrderItemField(); // Add one empty item field by default

            // Populate selects
            populateOrderForms();

            // Change button to create
            const createButton = document.querySelector('#createOrderForm .btn-success');
            createButton.textContent = 'إنشاء الطلب';
            createButton.onclick = createOrder;
        }

        function hideCreateOrderForm() {
            document.getElementById('createOrderForm').classList.add('hidden');
        }

        function populateOrderForms() {
            const customers = dataManager.getCustomers();
            const drivers = dataManager.getDrivers();
            const accountants = dataManager.getAccountants();
            const items = dataManager.getItems();

            const customerSelect = document.getElementById('orderCustomer');
            const accountantSelect = document.getElementById('orderAccountant');
            const driverSelect = document.getElementById('orderDriver');

            customerSelect.innerHTML = '<option value="">اختر العميل</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                customerSelect.appendChild(option);
            });

            accountantSelect.innerHTML = '<option value="">اختر المحاسب</option>';
            accountants.forEach(a => {
                const option = document.createElement('option');
                option.value = a.id;
                option.textContent = a.name;
                accountantSelect.appendChild(option);
            });

            driverSelect.innerHTML = '<option value="">اختر السائق</option>';
            drivers.forEach(d => {
                const option = document.createElement('option');
                option.value = d.id;
                option.textContent = d.name;
                driverSelect.appendChild(option);
            });

            // Populate item selects in order form
            document.querySelectorAll('.order-item-select').forEach(select => {
                select.innerHTML = '<option value="">اختر الصنف</option>';
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.name} (${formatCurrency(item.price)} / ${item.unit}, مخزون: ${item.stock})`;
                    option.dataset.price = item.price;
                    option.dataset.stock = item.stock;
                    option.dataset.unit = item.unit;
                    select.appendChild(option);
                });
            });
        }

        function addOrderItemField(item = null, quantity = 1) {
            const container = document.getElementById('orderItemsContainer');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex items-center gap-3 mb-2';
            itemDiv.innerHTML = `
                    <select class="form-input order-item-select" onchange="updateOrderItemPrice(this)">
                        <option value="">اختر الصنف</option>
                    </select>
                    <input type="number" placeholder="الكمية" class="form-input w-24 order-item-quantity" min="1" value="${quantity}">
                    <span class="order-item-price text-gray-700 font-medium w-24 text-left">${formatCurrency(0)}</span>
                    <button type="button" onclick="this.parentNode.remove()" class="btn btn-danger btn-sm flex-shrink-0 no-print">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            container.appendChild(itemDiv);
            populateOrderForms(); // Re-populate selects to include new field

            if (item) {
                const select = itemDiv.querySelector('.order-item-select');
                select.value = item.id;
                updateOrderItemPrice(select); // Update price based on selected item
            }
        }

        function updateOrderItemPrice(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const priceSpan = selectElement.parentNode.querySelector('.order-item-price');
            const quantityInput = selectElement.parentNode.querySelector('.order-item-quantity');

            if (selectedOption && selectedOption.value) {
                const price = parseFloat(selectedOption.dataset.price);
                const stock = parseInt(selectedOption.dataset.stock);
                const quantity = parseInt(quantityInput.value);

                if (quantity > stock) {
                    showAlert(`الكمية المطلوبة (${quantity}) للصنف ${selectedOption.textContent.split('(')[0].trim()} تتجاوز المخزون المتوفر (${stock}).`, 'warning');
                    quantityInput.value = stock; // Adjust quantity to available stock
                }

                priceSpan.textContent = formatCurrency(price);
            } else {
                priceSpan.textContent = formatCurrency(0);
            }
        }

        function createOrder() {
            const customerId = document.getElementById('orderCustomer').value;
            const accountantId = document.getElementById('orderAccountant').value;
            const driverId = document.getElementById('orderDriver').value;
            const priority = document.getElementById('orderPriority').value;
            const fromLocation = document.getElementById('orderFromLocation').value.trim();
            const toLocation = document.getElementById('orderToLocation').value.trim();
            const orderDateTime = document.getElementById('orderDateTime').value;
            const distance = parseFloat(document.getElementById('orderDistance').value) || 0;
            const paymentMethod = document.getElementById('orderPaymentMethod').value;
            const notes = document.getElementById('orderNotes').value.trim();

            const orderItems = [];
            let isValid = true;
            document.querySelectorAll('#orderItemsContainer > div').forEach(itemDiv => {
                const itemId = itemDiv.querySelector('.order-item-select').value;
                const quantity = parseInt(itemDiv.querySelector('.order-item-quantity').value);
                const itemData = dataManager.getItems().find(i => i.id === itemId);

                if (!itemId || isNaN(quantity) || quantity <= 0) {
                    showAlert('يرجى اختيار صنف وتحديد كمية صحيحة لكل صنف في الطلب.', 'error');
                    isValid = false;
                    return;
                }
                if (!itemData || itemData.stock < quantity) {
                    showAlert(`المخزون غير كافي للصنف ${itemData ? itemData.name : 'غير معروف'}.`, 'error');
                    isValid = false;
                    return;
                }
                orderItems.push({
                    id: itemId,
                    name: itemData.name,
                    price: itemData.price,
                    quantity: quantity,
                    unit: itemData.unit
                });
            });

            if (!isValid || !customerId || !accountantId || !driverId || !fromLocation || !toLocation || orderItems.length === 0) {
                showAlert('يرجى ملء جميع الحقول المطلوبة وإضافة أصناف للطلب.', 'error');
                return;
            }

            const newOrder = {
                customer: customerId,
                accountant: accountantId,
                driver: driverId,
                priority: priority,
                fromLocation: fromLocation,
                toLocation: toLocation,
                orderDateTime: orderDateTime,
                distance: distance,
                items: orderItems,
                paymentMethod: paymentMethod,
                notes: notes
            };

            if (dataManager.addOrder(newOrder)) {
                showAlert('تم إنشاء الطلب بنجاح!', 'success');
                hideCreateOrderForm();
                renderOrdersTable();
                updateDashboardStats();
                checkSmartAlerts();
            } else {
                showAlert('فشل إنشاء الطلب. تأكد من توفر المخزون.', 'error');
            }
        }

        function viewOrderDetails(orderId) {
            const order = dataManager.getOrders().find(o => o.id === orderId);
            if (!order) {
                showAlert('الطلب غير موجود.', 'error');
                return;
            }

            const customer = dataManager.getCustomers().find(c => c.id === order.customer);
            const accountant = dataManager.getAccountants().find(a => a.id === order.accountant);
            const driver = dataManager.getDrivers().find(d => d.id === order.driver);

            let itemsHtml = order.items.map(item => `
                    <li class="flex justify-between py-1">
                        <span>${item.name} (${item.quantity} ${item.unit})</span>
                        <span>${formatCurrency(item.price * item.quantity)}</span>
                    </li>
                `).join('');

            const invoiceHtml = `
                    <div class="invoice-section">
                        <div class="invoice-header">
                            <h2 class="text-3xl font-bold text-blue-700 mb-2">فاتورة طلب نقل</h2>
                            <p class="text-gray-600">رقم الفاتورة: INV-${order.orderNumber}</p>
                            <p class="text-gray-600">التاريخ: ${new Date(order.createdAt).toLocaleDateString('ar-SA')}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <h3 class="font-bold text-lg mb-2">معلومات العميل:</h3>
                                <p><strong>الاسم:</strong> ${customer ? customer.name : 'غير معروف'}</p>
                                <p><strong>الهاتف:</strong> ${customer ? customer.phone : 'غير معروف'}</p>
                                <p><strong>العنوان:</strong> ${customer ? customer.address : 'غير معروف'}</p>
                            </div>
                            <div class="text-left">
                                <h3 class="font-bold text-lg mb-2">تفاصيل الطلب:</h3>
                                <p><strong>من:</strong> ${order.fromLocation}</p>
                                <p><strong>إلى:</strong> ${order.toLocation}</p>
                                <p><strong>السائق:</strong> ${driver ? driver.name : 'غير معروف'}</p>
                                <p><strong>المحاسب:</strong> ${accountant ? accountant.name : 'غير معروف'}</p>
                            </div>
                        </div>
                        <div class="mb-6">
                            <h3 class="font-bold text-lg mb-2">الأصناف:</h3>
                            <ul class="border rounded-lg p-4 bg-gray-50">
                                ${itemsHtml}
                            </ul>
                        </div>
                        <div class="text-left border-t-2 border-gray-200 pt-4">
                            <p class="flex justify-between text-lg font-semibold mb-1"><span>المبلغ قبل الضريبة:</span> <span>${formatCurrency(order.subtotal)}</span></p>
                            <p class="flex justify-between text-lg font-semibold mb-1"><span>الضريبة (15%):</span> <span>${formatCurrency(order.vatAmount)}</span></p>
                            <p class="flex justify-between text-xl font-bold text-blue-700"><span>المبلغ الإجمالي:</span> <span>${formatCurrency(order.totalAmount)}</span></p>
                        </div>
                        <div class="mt-6 text-center">
                            <p class="text-gray-700">طريقة الدفع: <span class="font-bold">${order.paymentMethod}</span></p>
                            <p class="text-gray-700">حالة الدفع: <span class="status-badge status-${order.paymentStatus === 'completed' ? 'completed' : 'pending'}">${order.paymentStatus === 'completed' ? 'مدفوع' : 'معلق'}</span></p>
                            <p class="text-gray-700">حالة الطلب: <span class="status-badge status-${order.status === 'completed' ? 'completed' : order.status === 'in-progress' ? 'in-progress' : 'pending'}">${order.status === 'pending' ? 'قيد الانتظار' : order.status === 'in-progress' ? 'قيد التنفيذ' : order.status === 'completed' ? 'مكتمل' : 'ملغى'}</span></p>
                        </div>
                        <div class="mt-8 text-center no-print">
                            <button onclick="printInvoice()" class="btn btn-primary mr-2"><i class="fas fa-print"></i>طباعة الفاتورة</button>
                            <button onclick="this.parentNode.parentNode.remove()" class="btn btn-danger"><i class="fas fa-times"></i>إغلاق</button>
                        </div>
                    </div>
                `;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50';
            modal.innerHTML = invoiceHtml;
            document.body.appendChild(modal);
        }

        function printInvoice() {
            window.print();
        }

        function editOrder(orderId) {
            const order = dataManager.getOrders().find(o => o.id === orderId);
            if (!order) {
                showAlert('الطلب غير موجود.', 'error');
                return;
            }

            showCreateOrderForm(); // Reuse the form
            document.getElementById('orderCustomer').value = order.customer;
            document.getElementById('orderAccountant').value = order.accountant;
            document.getElementById('orderDriver').value = order.driver;
            document.getElementById('orderPriority').value = order.priority;
            document.getElementById('orderFromLocation').value = order.fromLocation;
            document.getElementById('orderToLocation').value = order.toLocation;
            document.getElementById('orderDateTime').value = order.orderDateTime ? new Date(order.orderDateTime).toISOString().slice(0, 16) : '';
            document.getElementById('orderDistance').value = order.distance;
            document.getElementById('orderPaymentMethod').value = order.paymentMethod;
            document.getElementById('orderNotes').value = order.notes;

            // Populate order items
            const orderItemsContainer = document.getElementById('orderItemsContainer');
            orderItemsContainer.innerHTML = ''; // Clear existing fields
            order.items.forEach(item => {
                addOrderItemField(item, item.quantity);
            });

            // Change button to update
            const createButton = document.querySelector('#createOrderForm .btn-success');
            createButton.textContent = 'تحديث الطلب';
            createButton.onclick = () => updateOrder(orderId);
        }

        function updateOrder(orderId) {
            const customerId = document.getElementById('orderCustomer').value;
            const accountantId = document.getElementById('orderAccountant').value;
            const driverId = document.getElementById('orderDriver').value;
            const priority = document.getElementById('orderPriority').value;
            const fromLocation = document.getElementById('orderFromLocation').value.trim();
            const toLocation = document.getElementById('orderToLocation').value.trim();
            const orderDateTime = document.getElementById('orderDateTime').value;
            const distance = parseFloat(document.getElementById('orderDistance').value) || 0;
            const paymentMethod = document.getElementById('orderPaymentMethod').value;
            const notes = document.getElementById('orderNotes').value.trim();

            const orderItems = [];
            let isValid = true;
            document.querySelectorAll('#orderItemsContainer > div').forEach(itemDiv => {
                const itemId = itemDiv.querySelector('.order-item-select').value;
                const quantity = parseInt(itemDiv.querySelector('.order-item-quantity').value);
                const itemData = dataManager.getItems().find(i => i.id === itemId);

                if (!itemId || isNaN(quantity) || quantity <= 0) {
                    showAlert('يرجى اختيار صنف وتحديد كمية صحيحة لكل صنف في الطلب.', 'error');
                    isValid = false;
                    return;
                }
                if (!itemData) {
                    showAlert('الصنف المحدد غير موجود.', 'error');
                    isValid = false;
                    return;
                }
                orderItems.push({
                    id: itemId,
                    name: itemData.name,
                    price: itemData.price,
                    quantity: quantity,
                    unit: itemData.unit
                });
            });

            if (!isValid || !customerId || !accountantId || !driverId || !fromLocation || !toLocation || orderItems.length === 0) {
                showAlert('يرجى ملء جميع الحقول المطلوبة وإضافة أصناف للطلب.', 'error');
                return;
            }

            const updatedOrder = {
                customer: customerId,
                accountant: accountantId,
                driver: driverId,
                priority: priority,
                fromLocation: fromLocation,
                toLocation: toLocation,
                orderDateTime: orderDateTime,
                distance: distance,
                items: orderItems,
                paymentMethod: paymentMethod,
                notes: notes
            };

            // Re-calculate VAT for updated order
            const subtotal = updatedOrder.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            updatedOrder.subtotal = subtotal;
            updatedOrder.vatAmount = subtotal * dataManager.vatRate;
            updatedOrder.totalAmount = subtotal + updatedOrder.vatAmount;

            if (dataManager.updateOrder(orderId, updatedOrder)) {
                showAlert('تم تحديث الطلب بنجاح!', 'success');
                hideCreateOrderForm();
                renderOrdersTable();
                updateDashboardStats();
                checkSmartAlerts();
                // Reset button
                const createButton = document.querySelector('#createOrderForm .btn-success');
                createButton.textContent = 'إنشاء الطلب';
                createButton.onclick = createOrder;
            } else {
                showAlert('فشل تحديث الطلب.', 'error');
            }
        }

        function deleteOrder(orderId) {
            if (confirm('هل أنت متأكد من حذف هذا الطلب؟ سيتم إعادة الأصناف إلى المخزون.')) {
                if (dataManager.deleteOrder(orderId)) {
                    showAlert('تم حذف الطلب بنجاح!', 'success');
                    renderOrdersTable();
                    updateDashboardStats();
                    checkSmartAlerts();
                } else {
                    showAlert('فشل حذف الطلب.', 'error');
                }
            }
        }

        // Customers CRM Functions
        function renderCustomersList() {
            const customersListDiv = document.getElementById('customersList');
            customersListDiv.innerHTML = '';
            const customers = dataManager.getCustomers();

            if (customers.length === 0) {
                customersListDiv.innerHTML = '<p class="text-gray-600 text-center py-8 col-span-2">لا توجد عملاء مسجلين حالياً. ابدأ بإضافة عميل جديد.</p>';
                return;
            }

            customers.forEach(customer => {
                const customerCard = document.createElement('div');
                customerCard.className = 'customer-card';
                customerCard.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-lg text-gray-800">${customer.name}</h4>
                            <span class="crm-status ${customer.segment}">${customer.segment === 'hot' ? 'ساخن' : customer.segment === 'warm' ? 'دافئ' : 'بارد'}</span>
                        </div>
                        <p class="text-gray-700 mb-2"><i class="fas fa-phone ml-2 text-gray-500"></i>${customer.phone}</p>
                        <p class="text-gray-700 mb-2"><i class="fas fa-envelope ml-2 text-gray-500"></i>${customer.email || 'لا يوجد'}</p>
                        <p class="text-gray-700 mb-2"><i class="fas fa-map-marker-alt ml-2 text-gray-500"></i>${customer.address || 'لا يوجد'}</p>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-4">
                            <div><strong>النوع:</strong> ${customer.type === 'individual' ? 'فرد' : customer.type === 'company' ? 'شركة' : 'حكومي'}</div>
                            <div><strong>الرقم الضريبي:</strong> ${customer.taxNumber || 'لا يوجد'}</div>
                            <div><strong>مصدر العميل:</strong> ${customer.source}</div>
                            <div><strong>حد الائتمان:</strong> ${formatCurrency(customer.creditLimit || 0)}</div>
                        </div>
                        <div class="flex gap-2 justify-end no-print">
                            <button onclick="editCustomer('${customer.id}')" class="btn btn-sm btn-warning"><i class="fas fa-edit"></i>تعديل</button>
                            <button onclick="deleteCustomer('${customer.id}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i>حذف</button>
                        </div>
                    `;
                customersListDiv.appendChild(customerCard);
            });
        }

        function showAddCustomerForm() {
            document.getElementById('addCustomerForm').classList.remove('hidden');
            // Clear form fields
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerType').value = 'individual';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerTaxNumber').value = '';
            document.getElementById('customerJoinDate').valueAsDate = new Date();
            document.getElementById('customerSegment').value = 'cold';
            document.getElementById('customerSource').value = 'referral';
            document.getElementById('customerNotes').value = '';
            document.getElementById('customerCreditLimit').value = '';
        }

        function hideAddCustomerForm() {
            document.getElementById('addCustomerForm').classList.add('hidden');
        }

        function addCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const type = document.getElementById('customerType').value;
            const address = document.getElementById('customerAddress').value.trim();
            const taxNumber = document.getElementById('customerTaxNumber').value.trim();
            const joinDate = document.getElementById('customerJoinDate').value;
            const segment = document.getElementById('customerSegment').value;
            const source = document.getElementById('customerSource').value;
            const notes = document.getElementById('customerNotes').value.trim();
            const creditLimit = parseFloat(document.getElementById('customerCreditLimit').value) || 0;

            if (!name || !phone) {
                showAlert('يرجى ملء اسم العميل ورقم الهاتف.', 'error');
                return;
            }

            const newCustomer = { name, phone, email, type, address, taxNumber, joinDate, segment, source, notes, creditLimit };
            if (dataManager.addCustomer(newCustomer)) {
                showAlert('تم إضافة العميل بنجاح!', 'success');
                hideAddCustomerForm();
                renderCustomersList();
                updateCRMCards();
                updateDashboardStats();
            } else {
                showAlert('فشل إضافة العميل.', 'error');
            }
        }

        function editCustomer(id) {
            const customers = dataManager.getCustomers();
            const customer = customers.find(c => c.id === id);
            if (customer) {
                showAddCustomerForm();
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerPhone').value = customer.phone;
                document.getElementById('customerEmail').value = customer.email;
                document.getElementById('customerType').value = customer.type;
                document.getElementById('customerAddress').value = customer.address;
                document.getElementById('customerTaxNumber').value = customer.taxNumber;
                document.getElementById('customerJoinDate').value = customer.createdAt ? new Date(customer.createdAt).toISOString().split('T')[0] : '';
                document.getElementById('customerSegment').value = customer.segment;
                document.getElementById('customerSource').value = customer.source;
                document.getElementById('customerNotes').value = customer.notes;
                document.getElementById('customerCreditLimit').value = customer.creditLimit;

                const addButton = document.querySelector('#addCustomerForm .btn-success');
                addButton.textContent = 'تحديث العميل';
                addButton.onclick = () => updateCustomer(id);
            }
        }

        function updateCustomer(id) {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const type = document.getElementById('customerType').value;
            const address = document.getElementById('customerAddress').value.trim();
            const taxNumber = document.getElementById('customerTaxNumber').value.trim();
            const joinDate = document.getElementById('customerJoinDate').value;
            const segment = document.getElementById('customerSegment').value;
            const source = document.getElementById('customerSource').value;
            const notes = document.getElementById('customerNotes').value.trim();
            const creditLimit = parseFloat(document.getElementById('customerCreditLimit').value) || 0;

            if (!name || !phone) {
                showAlert('يرجى ملء اسم العميل ورقم الهاتف.', 'error');
                return;
            }

            const updatedCustomer = { name, phone, email, type, address, taxNumber, joinDate, segment, source, notes, creditLimit };
            if (dataManager.updateCustomer(id, updatedCustomer)) {
                showAlert('تم تحديث العميل بنجاح!', 'success');
                hideAddCustomerForm();
                renderCustomersList();
                updateCRMCards();
                updateDashboardStats();
                const addButton = document.querySelector('#addCustomerForm .btn-success');
                addButton.textContent = 'إضافة العميل';
                addButton.onclick = addCustomer;
            } else {
                showAlert('فشل تحديث العميل.', 'error');
            }
        }

        function deleteCustomer(id) {
            if (confirm('هل أنت متأكد من حذف هذا العميل؟')) {
                if (dataManager.deleteCustomer(id)) {
                    showAlert('تم حذف العميل بنجاح!', 'success');
                    renderCustomersList();
                    updateCRMCards();
                    updateDashboardStats();
                } else {
                    showAlert('فشل حذف العميل.', 'error');
                }
            }
        }

        function updateCRMCards() {
            const customers = dataManager.getCustomers();
            const hotCustomers = customers.filter(c => c.segment === 'hot').length;
            const warmCustomers = customers.filter(c => c.segment === 'warm').length;
            const coldCustomers = customers.filter(c => c.segment === 'cold').length;

            document.getElementById('hotCustomersCount').textContent = hotCustomers;
            document.getElementById('warmCustomersCount').textContent = warmCustomers;
            document.getElementById('coldCustomersCount').textContent = coldCustomers;
        }

        function exportCustomersAnalysis() {
            const customers = dataManager.getCustomers();
            const data = customers.map(c => ({
                'اسم العميل': c.name,
                'رقم الهاتف': c.phone,
                'البريد الإلكتروني': c.email,
                'نوع العميل': c.type,
                'تصنيف العميل': c.segment,
                'مصدر العميل': c.source,
                'حد الائتمان': c.creditLimit,
                'تاريخ التسجيل': new Date(c.createdAt).toLocaleDateString('ar-SA'),
                'إجمالي الطلبات': c.totalOrders,
                'إجمالي الإنفاق': c.totalSpent
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "تحليل العملاء");
            XLSX.writeFile(wb, "تحليل_العملاء.xlsx");
            dataManager.addAuditLog('تصدير', 'تم تصدير تحليل العملاء إلى Excel');
            showAlert('تم تصدير تحليل العملاء بنجاح!', 'success');
        }

        // Drivers Management Functions
        function renderDriversList() {
            const driversListDiv = document.getElementById('driversList');
            driversListDiv.innerHTML = '';
            const drivers = dataManager.getDrivers();

            if (drivers.length === 0) {
                driversListDiv.innerHTML = '<p class="text-gray-600 text-center py-8 col-span-2">لا توجد سائقين مسجلين حالياً. ابدأ بإضافة سائق جديد.</p>';
                return;
            }

            drivers.forEach(driver => {
                const driverCard = document.createElement('div');
                driverCard.className = `driver-card ${driver.active ? 'active' : ''}`;
                driverCard.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-lg text-gray-800">${driver.name}</h4>
                            <span class="status-badge ${driver.active ? 'status-completed' : 'status-cancelled'}">${driver.active ? 'نشط' : 'غير نشط'}</span>
                        </div>
                        <p class="text-gray-700 mb-2"><i class="fas fa-phone ml-2 text-gray-500"></i>${driver.phone}</p>
                        <p class="text-gray-700 mb-2"><i class="fas fa-id-card ml-2 text-gray-500"></i>رخصة: ${driver.license} (انتهاء: ${new Date(driver.licenseExpiry).toLocaleDateString('ar-SA')})</p>
                        <p class="text-gray-700 mb-2"><i class="fas fa-car ml-2 text-gray-500"></i>مركبة: ${driver.carId} (${driver.carType})</p>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-4">
                            <div><strong>الراتب:</strong> ${formatCurrency(driver.salary)}</div>
                            <div><strong>التقييم:</strong> ${driver.rating} <i class="fas fa-star text-yellow-500"></i></div>
                            <div><strong>الرحلات:</strong> ${driver.totalTrips}</div>
                            <div><strong>الأرباح:</strong> ${formatCurrency(driver.totalEarnings)}</div>
                        </div>
                        <div class="flex gap-2 justify-end no-print">
                            <button onclick="editDriver('${driver.id}')" class="btn btn-sm btn-warning"><i class="fas fa-edit"></i>تعديل</button>
                            <button onclick="deleteDriver('${driver.id}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i>حذف</button>
                        </div>
                    `;
                driversListDiv.appendChild(driverCard);
            });
        }

        function showAddDriverForm() {
            document.getElementById('addDriverForm').classList.remove('hidden');
            // Clear form fields
            document.getElementById('driverName').value = '';
            document.getElementById('driverIdNumber').value = '';
            document.getElementById('driverPhone').value = '';
            document.getElementById('driverBirthDate').value = '';
            document.getElementById('driverLicense').value = '';
            document.getElementById('driverLicenseExpiry').value = '';
            document.getElementById('driverCarId').value = '';
            document.getElementById('driverCarType').value = '';
            document.getElementById('driverHireDate').value = '';
            document.getElementById('driverSalary').value = '';
            document.getElementById('driverEmploymentStatus').value = 'full-time';
            document.getElementById('driverRating').value = '5';
        }

        function hideAddDriverForm() {
            document.getElementById('addDriverForm').classList.add('hidden');
        }

        function addDriver() {
            const name = document.getElementById('driverName').value.trim();
            const idNumber = document.getElementById('driverIdNumber').value.trim();
            const phone = document.getElementById('driverPhone').value.trim();
            const birthDate = document.getElementById('driverBirthDate').value;
            const license = document.getElementById('driverLicense').value.trim();
            const licenseExpiry = document.getElementById('driverLicenseExpiry').value;
            const carId = document.getElementById('driverCarId').value.trim();
            const carType = document.getElementById('driverCarType').value;
            const hireDate = document.getElementById('driverHireDate').value;
            const salary = parseFloat(document.getElementById('driverSalary').value) || 0;
            const employmentStatus = document.getElementById('driverEmploymentStatus').value;
            const rating = parseInt(document.getElementById('driverRating').value);

            if (!name || !idNumber || !phone || !license || !licenseExpiry || !carId) {
                showAlert('يرجى ملء جميع الحقول المطلوبة للسائق (الاسم، الهوية، الهاتف، الرخصة، انتهاء الرخصة، رقم المركبة).', 'error');
                return;
            }

            const newDriver = { name, idNumber, phone, birthDate, license, licenseExpiry, carId, carType, hireDate, salary, employmentStatus, rating };
            if (dataManager.addDriver(newDriver)) {
                showAlert('تم إضافة السائق بنجاح!', 'success');
                hideAddDriverForm();
                renderDriversList();
                updateDashboardStats();
                checkSmartAlerts();
            } else {
                showAlert('فشل إضافة السائق.', 'error');
            }
        }

        function editDriver(id) {
            const drivers = dataManager.getDrivers();
            const driver = drivers.find(d => d.id === id);
            if (driver) {
                showAddDriverForm();
                document.getElementById('driverName').value = driver.name;
                document.getElementById('driverIdNumber').value = driver.idNumber;
                document.getElementById('driverPhone').value = driver.phone;
                document.getElementById('driverBirthDate').value = driver.birthDate;
                document.getElementById('driverLicense').value = driver.license;
                document.getElementById('driverLicenseExpiry').value = driver.licenseExpiry;
                document.getElementById('driverCarId').value = driver.carId;
                document.getElementById('driverCarType').value = driver.carType;
                document.getElementById('driverHireDate').value = driver.hireDate;
                document.getElementById('driverSalary').value = driver.salary;
                document.getElementById('driverEmploymentStatus').value = driver.employmentStatus;
                document.getElementById('driverRating').value = driver.rating;

                const addButton = document.querySelector('#addDriverForm .btn-success');
                addButton.textContent = 'تحديث السائق';
                addButton.onclick = () => updateDriver(id);
            }
        }

        function updateDriver(id) {
            const name = document.getElementById('driverName').value.trim();
            const idNumber = document.getElementById('driverIdNumber').value.trim();
            const phone = document.getElementById('driverPhone').value.trim();
            const birthDate = document.getElementById('driverBirthDate').value;
            const license = document.getElementById('driverLicense').value.trim();
            const licenseExpiry = document.getElementById('driverLicenseExpiry').value;
            const carId = document.getElementById('driverCarId').value.trim();
            const carType = document.getElementById('driverCarType').value;
            const hireDate = document.getElementById('driverHireDate').value;
            const salary = parseFloat(document.getElementById('driverSalary').value) || 0;
            const employmentStatus = document.getElementById('driverEmploymentStatus').value;
            const rating = parseInt(document.getElementById('driverRating').value);

            if (!name || !idNumber || !phone || !license || !licenseExpiry || !carId) {
                showAlert('يرجى ملء جميع الحقول المطلوبة للسائق (الاسم، الهوية، الهاتف، الرخصة، انتهاء الرخصة، رقم المركبة).', 'error');
                return;
            }

            const updatedDriver = { name, idNumber, phone, birthDate, license, licenseExpiry, carId, carType, hireDate, salary, employmentStatus, rating };
            if (dataManager.updateDriver(id, updatedDriver)) {
                showAlert('تم تحديث بيانات السائق بنجاح!', 'success');
                hideAddDriverForm();
                renderDriversList();
                updateDashboardStats();
                checkSmartAlerts();
                const addButton = document.querySelector('#addDriverForm .btn-success');
                addButton.textContent = 'إضافة السائق';
                addButton.onclick = addDriver;
            } else {
                showAlert('فشل تحديث بيانات السائق.', 'error');
            }
        }

        function deleteDriver(id) {
            if (confirm('هل أنت متأكد من حذف هذا السائق؟')) {
                if (dataManager.deleteDriver(id)) {
                    showAlert('تم حذف السائق بنجاح!', 'success');
                    renderDriversList();
                    updateDashboardStats();
                    checkSmartAlerts();
                } else {
                    showAlert('فشل حذف السائق.', 'error');
                }
            }
        }

        function checkDriverLicenses() {
            const drivers = dataManager.getDrivers();
            const expiringLicenses = drivers.filter(driver => {
                if (!driver.licenseExpiry) return false;
                const expiryDate = new Date(driver.licenseExpiry);
                const today = new Date();
                const diffTime = expiryDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 90 && diffDays >= 0; // Expiring within 90 days
            });

            if (expiringLicenses.length > 0) {
                let message = 'الرخص التالية على وشك الانتهاء:\n';
                expiringLicenses.forEach(driver => {
                    const expiryDate = new Date(driver.licenseExpiry);
                    const today = new Date();
                    const diffTime = expiryDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    message += `- ${driver.name} (رخصة: ${driver.license}) تنتهي في ${new Date(driver.licenseExpiry).toLocaleDateString('ar-SA')} (تبقى ${diffDays} يوم)\n`;
                });
                showAlert(message, 'warning');
            } else {
                showAlert('لا توجد رخص قيادة على وشك الانتهاء خلال الـ 90 يوماً القادمة.', 'success');
            }
        }

        // Maintenance Management Functions
        function renderMaintenanceTable() {
            const maintenanceTableBody = document.getElementById('maintenanceTable');
            maintenanceTableBody.innerHTML = '';
            const records = dataManager.getMaintenanceRecords().sort((a, b) => new Date(b.maintenanceDate) - new Date(a.maintenanceDate));
            const drivers = dataManager.getDrivers();

            if (records.length === 0) {
                maintenanceTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-600">لا توجد سجلات صيانة حالياً.</td></tr>';
                return;
            }

            records.forEach(record => {
                const driver = drivers.find(d => d.carId === record.vehicleId);
                const row = maintenanceTableBody.insertRow();
                row.innerHTML = `
                        <td>${record.vehicleId} (${driver ? driver.name : 'غير معروف'})</td>
                        <td>${record.maintenanceType}</td>
                        <td>${new Date(record.maintenanceDate).toLocaleDateString('ar-SA')}</td>
                        <td>${formatCurrency(record.maintenanceCost)}</td>
                        <td>${record.maintenanceMileage ? record.maintenanceMileage + ' كم' : 'غير محدد'}</td>
                        <td>${record.maintenanceProvider || 'غير محدد'}</td>
                        <td><span class="status-badge status-${record.maintenanceStatus === 'excellent' ? 'completed' : record.maintenanceStatus === 'good' ? 'in-progress' : 'pending'}">${record.maintenanceStatus}</span></td>
                        <td>${record.maintenanceNextMileage ? record.maintenanceNextMileage + ' كم' : 'غير محدد'}</td>
                        <td class="no-print">
                            <button onclick="editMaintenanceRecord('${record.id}')" class="btn btn-sm btn-warning"><i class="fas fa-edit"></i>تعديل</button>
                            <button onclick="deleteMaintenanceRecord('${record.id}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i>حذف</button>
                        </td>
                    `;
            });
        }

        function populateMaintenanceVehicleSelect() {
            const vehicleSelect = document.getElementById('maintenanceVehicle');
            vehicleSelect.innerHTML = '<option value="">اختر المركبة</option>';
            const drivers = dataManager.getDrivers(); // Assuming vehicles are linked to drivers by carId
            drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.carId;
                option.textContent = `${driver.carId} (${driver.carType} - ${driver.name})`;
                vehicleSelect.appendChild(option);
            });
        }

        function showAddMaintenanceForm() {
            document.getElementById('addMaintenanceForm').classList.remove('hidden');
            // Clear form fields
            document.getElementById('maintenanceVehicle').value = '';
            document.getElementById('maintenanceType').value = '';
            document.getElementById('maintenanceDate').valueAsDate = new Date();
            document.getElementById('maintenanceCost').value = '';
            document.getElementById('maintenanceMileage').value = '';
            document.getElementById('maintenanceNextMileage').value = '';
            document.getElementById('maintenanceProvider').value = '';
            document.getElementById('maintenanceDescription').value = '';
            document.getElementById('maintenanceStatus').value = 'good';

            populateMaintenanceVehicleSelect();

            const addButton = document.querySelector('#addMaintenanceForm .btn-success');
            addButton.textContent = 'إضافة السجل';
            addButton.onclick = addMaintenance;
        }

        function hideAddMaintenanceForm() {
            document.getElementById('addMaintenanceForm').classList.add('hidden');
        }

        function addMaintenance() {
            const vehicleId = document.getElementById('maintenanceVehicle').value;
            const type = document.getElementById('maintenanceType').value;
            const date = document.getElementById('maintenanceDate').value;
            const cost = parseFloat(document.getElementById('maintenanceCost').value) || 0;
            const mileage = parseFloat(document.getElementById('maintenanceMileage').value) || 0;
            const nextMileage = parseFloat(document.getElementById('maintenanceNextMileage').value) || 0;
            const provider = document.getElementById('maintenanceProvider').value.trim();
            const description = document.getElementById('maintenanceDescription').value.trim();
            const status = document.getElementById('maintenanceStatus').value;

            if (!vehicleId || !type || !date) {
                showAlert('يرجى ملء الحقول المطلوبة (المركبة، نوع الصيانة، التاريخ).', 'error');
                return;
            }

            const newRecord = { vehicleId, type, date, cost, mileage, nextMileage, provider, description, status };
            if (dataManager.addMaintenanceRecord(newRecord)) {
                showAlert('تم إضافة سجل الصيانة بنجاح!', 'success');
                hideAddMaintenanceForm();
                renderMaintenanceTable();
                checkSmartAlerts();
            } else {
                showAlert('فشل إضافة سجل الصيانة.', 'error');
            }
        }

        function editMaintenanceRecord(id) {
            const records = dataManager.getMaintenanceRecords();
            const record = records.find(r => r.id === id);
            if (record) {
                showAddMaintenanceForm();
                document.getElementById('maintenanceVehicle').value = record.vehicleId;
                document.getElementById('maintenanceType').value = record.type;
                document.getElementById('maintenanceDate').value = record.date;
                document.getElementById('maintenanceCost').value = record.cost;
                document.getElementById('maintenanceMileage').value = record.mileage;
                document.getElementById('maintenanceNextMileage').value = record.nextMileage;
                document.getElementById('maintenanceProvider').value = record.provider;
                document.getElementById('maintenanceDescription').value = record.description;
                document.getElementById('maintenanceStatus').value = record.status;

                const addButton = document.querySelector('#addMaintenanceForm .btn-success');
                addButton.textContent = 'تحديث السجل';
                addButton.onclick = () => updateMaintenanceRecord(id);
            }
        }

        function updateMaintenanceRecord(id) {
            const vehicleId = document.getElementById('maintenanceVehicle').value;
            const type = document.getElementById('maintenanceType').value;
            const date = document.getElementById('maintenanceDate').value;
            const cost = parseFloat(document.getElementById('maintenanceCost').value) || 0;
            const mileage = parseFloat(document.getElementById('maintenanceMileage').value) || 0;
            const nextMileage = parseFloat(document.getElementById('maintenanceNextMileage').value) || 0;
            const provider = document.getElementById('maintenanceProvider').value.trim();
            const description = document.getElementById('maintenanceDescription').value.trim();
            const status = document.getElementById('maintenanceStatus').value;

            if (!vehicleId || !type || !date) {
                showAlert('يرجى ملء الحقول المطلوبة (المركبة، نوع الصيانة، التاريخ).', 'error');
                return;
            }

            const updatedRecord = { vehicleId, type, date, cost, mileage, nextMileage, provider, description, status };
            if (dataManager.updateMaintenanceRecord(id, updatedRecord)) {
                showAlert('تم تحديث سجل الصيانة بنجاح!', 'success');
                hideAddMaintenanceForm();
                renderMaintenanceTable();
                checkSmartAlerts();
                const addButton = document.querySelector('#addMaintenanceForm .btn-success');
                addButton.textContent = 'إضافة السجل';
                addButton.onclick = addMaintenance;
            } else {
                showAlert('فشل تحديث سجل الصيانة.', 'error');
            }
        }

        function deleteMaintenanceRecord(id) {
            if (confirm('هل أنت متأكد من حذف سجل الصيانة هذا؟')) {
                if (dataManager.deleteMaintenanceRecord(id)) {
                    showAlert('تم حذف سجل الصيانة بنجاح!', 'success');
                    renderMaintenanceTable();
                    checkSmartAlerts();
                } else {
                    showAlert('فشل حذف سجل الصيانة.', 'error');
                }
            }
        }

        function checkScheduledMaintenance() {
            const maintenanceAlertsDiv = document.getElementById('maintenanceAlerts');
            maintenanceAlertsDiv.innerHTML = ''; // Clear previous alerts

            const records = dataManager.getMaintenanceRecords();
            const drivers = dataManager.getDrivers();
            const today = new Date();

            const upcomingMaintenance = records.filter(record => {
                if (!record.nextMileage || !record.mileage) return false; // Needs both current and next mileage for calculation
                // Simplified: if nextMileage is set and current mileage is close to it, or if date is approaching
                const lastMaintenanceDate = new Date(record.date);
                const daysSinceLastMaintenance = Math.ceil((today.getTime() - lastMaintenanceDate.getTime()) / (1000 * 60 * 60 * 24));

                // Example: Alert if next maintenance is due within 30 days or 1000km
                // This requires tracking current vehicle mileage, which is not in this demo.
                // For now, we'll just alert if nextMileage is set and it's been a while since last maintenance.
                return daysSinceLastMaintenance > 180; // Example: alert if more than 6 months since last maintenance
            });

            if (upcomingMaintenance.length > 0) {
                upcomingMaintenance.forEach(record => {
                    const driver = drivers.find(d => d.carId === record.vehicleId);
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'maintenance-alert';
                    alertDiv.innerHTML = `
                            <i class="fas fa-exclamation-circle ml-2"></i>
                            <strong>تنبيه صيانة للمركبة ${record.vehicleId} (${driver ? driver.name : 'غير معروف'})</strong>
                            <p class="text-sm mt-1">نوع الصيانة: ${record.type}. آخر صيانة كانت في ${new Date(record.date).toLocaleDateString('ar-SA')}.</p>
                            <p class="text-sm">ينصح بالصيانة التالية عند ${record.nextMileage} كم.</p>
                        `;
                    maintenanceAlertsDiv.appendChild(alertDiv);
                });
            } else {
                maintenanceAlertsDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle ml-2"></i>لا توجد تنبيهات صيانة مجدولة حالياً.</div>';
            }
        }

        // Accountants Management Functions
        function renderAccountantsList() {
            const accountantsListDiv = document.getElementById('accountantsList');
            accountantsListDiv.innerHTML = '';
            const accountants = dataManager.getAccountants();

            if (accountants.length === 0) {
                accountantsListDiv.innerHTML = '<p class="text-gray-600 text-center py-8 col-span-2">لا توجد محاسبين مسجلين حالياً. ابدأ بإضافة محاسب جديد.</p>';
                return;
            }

            accountants.forEach(accountant => {
                const accountantCard = document.createElement('div');
                accountantCard.className = `accountant-card ${accountant.active ? 'active' : ''}`;
                accountantCard.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-lg text-gray-800">${accountant.name}</h4>
                            <span class="status-badge ${accountant.active ? 'status-completed' : 'status-cancelled'}">${accountant.active ? 'نشط' : 'غير نشط'}</span>
                        </div>
                        <p class="text-gray-700 mb-2"><i class="fas fa-phone ml-2 text-gray-500"></i>${accountant.phone}</p>
                        <p class="text-gray-700 mb-2"><i class="fas fa-envelope ml-2 text-gray-500"></i>${accountant.email}</p>
                        <p class="text-gray-700 mb-2"><i class="fas fa-id-badge ml-2 text-gray-500"></i>رقم الموظف: ${accountant.employeeId}</p>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-4">
                            <div><strong>المسمى:</strong> ${accountant.position}</div>
                            <div><strong>الصلاحية:</strong> ${accountant.accessLevel}</div>
                            <div><strong>الراتب:</strong> ${formatCurrency(accountant.salary)}</div>
                            <div><strong>الطلبات المعالجة:</strong> ${accountant.totalOrdersProcessed}</div>
                        </div>
                        <div class="flex gap-2 justify-end no-print">
                            <button onclick="editAccountant('${accountant.id}')" class="btn btn-sm btn-warning"><i class="fas fa-edit"></i>تعديل</button>
                            <button onclick="deleteAccountant('${accountant.id}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i>حذف</button>
                        </div>
                    `;
                accountantsListDiv.appendChild(accountantCard);
            });
        }

        function showAddAccountantForm() {
            document.getElementById('addAccountantForm').classList.remove('hidden');
            // Clear form fields
            document.getElementById('accountantName').value = '';
            document.getElementById('accountantPhone').value = '';
            document.getElementById('accountantEmail').value = '';
            document.getElementById('accountantEmployeeId').value = '';
            document.getElementById('accountantPosition').value = '';
            document.getElementById('accountantHireDate').value = '';
            document.getElementById('accountantAccessLevel').value = 'basic';
            document.getElementById('accountantSalary').value = '';
            document.getElementById('accountantNotes').value = '';
        }

        function hideAddAccountantForm() {
            document.getElementById('addAccountantForm').classList.add('hidden');
        }

        function addAccountant() {
            const name = document.getElementById('accountantName').value.trim();
            const phone = document.getElementById('accountantPhone').value.trim();
            const email = document.getElementById('accountantEmail').value.trim();
            const employeeId = document.getElementById('accountantEmployeeId').value.trim();
            const position = document.getElementById('accountantPosition').value.trim();
            const hireDate = document.getElementById('accountantHireDate').value;
            const accessLevel = document.getElementById('accountantAccessLevel').value;
            const salary = parseFloat(document.getElementById('accountantSalary').value) || 0;
            const notes = document.getElementById('accountantNotes').value.trim();

            if (!name || !phone || !email || !employeeId) {
                showAlert('يرجى ملء الحقول المطلوبة للمحاسب (الاسم، الهاتف، البريد الإلكتروني، رقم الموظف).', 'error');
                return;
            }

            const newAccountant = { name, phone, email, employeeId, position, hireDate, accessLevel, salary, notes };
            if (dataManager.addAccountant(newAccountant)) {
                showAlert('تم إضافة المحاسب بنجاح!', 'success');
                hideAddAccountantForm();
                renderAccountantsList();
                updateDashboardStats();
            } else {
                showAlert('فشل إضافة المحاسب.', 'error');
            }
        }

        function editAccountant(id) {
            const accountants = dataManager.getAccountants();
            const accountant = accountants.find(a => a.id === id);
            if (accountant) {
                showAddAccountantForm();
                document.getElementById('accountantName').value = accountant.name;
                document.getElementById('accountantPhone').value = accountant.phone;
                document.getElementById('accountantEmail').value = accountant.email;
                document.getElementById('accountantEmployeeId').value = accountant.employeeId;
                document.getElementById('accountantPosition').value = accountant.position;
                document.getElementById('accountantHireDate').value = accountant.hireDate;
                document.getElementById('accountantAccessLevel').value = accountant.accessLevel;
                document.getElementById('accountantSalary').value = accountant.salary;
                document.getElementById('accountantNotes').value = accountant.notes;

                const addButton = document.querySelector('#addAccountantForm .btn-success');
                addButton.textContent = 'تحديث المحاسب';
                addButton.onclick = () => updateAccountant(id);
            }
        }

        function updateAccountant(id) {
            const name = document.getElementById('accountantName').value.trim();
            const phone = document.getElementById('accountantPhone').value.trim();
            const email = document.getElementById('accountantEmail').value.trim();
            const employeeId = document.getElementById('accountantEmployeeId').value.trim();
            const position = document.getElementById('accountantPosition').value.trim();
            const hireDate = document.getElementById('accountantHireDate').value;
            const accessLevel = document.getElementById('accountantAccessLevel').value;
            const salary = parseFloat(document.getElementById('accountantSalary').value) || 0;
            const notes = document.getElementById('accountantNotes').value.trim();

            if (!name || !phone || !email || !employeeId) {
                showAlert('يرجى ملء الحقول المطلوبة للمحاسب (الاسم، الهاتف، البريد الإلكتروني، رقم الموظف).', 'error');
                return;
            }

            const updatedAccountant = { name, phone, email, employeeId, position, hireDate, accessLevel, salary, notes };
            if (dataManager.updateAccountant(id, updatedAccountant)) {
                showAlert('تم تحديث بيانات المحاسب بنجاح!', 'success');
                hideAddAccountantForm();
                renderAccountantsList();
                updateDashboardStats();
                const addButton = document.querySelector('#addAccountantForm .btn-success');
                addButton.textContent = 'إضافة المحاسب';
                addButton.onclick = addAccountant;
            } else {
                showAlert('فشل تحديث بيانات المحاسب.', 'error');
            }
        }

        function deleteAccountant(id) {
            if (confirm('هل أنت متأكد من حذف هذا المحاسب؟')) {
                if (dataManager.deleteAccountant(id)) {
                    showAlert('تم حذف المحاسب بنجاح!', 'success');
                    renderAccountantsList();
                    updateDashboardStats();
                } else {
                    showAlert('فشل حذف المحاسب.', 'error');
                }
            }
        }

        // Payment System Functions
        function renderPaymentsTable() {
            const paymentsTableBody = document.getElementById('paymentsTable');
            paymentsTableBody.innerHTML = '';
            const payments = dataManager.getPayments().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const orders = dataManager.getOrders();
            const customers = dataManager.getCustomers();

            if (payments.length === 0) {
                paymentsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-600">لا توجد مدفوعات مسجلة حالياً.</td></tr>';
                return;
            }

            payments.forEach(payment => {
                const order = orders.find(o => o.id === payment.orderId);
                const customer = order ? customers.find(c => c.id === order.customer) : null;

                const row = paymentsTableBody.insertRow();
                row.innerHTML = `
                        <td>${order ? `ط-${order.orderNumber}` : 'غير معروف'}</td>
                        <td>${customer ? customer.name : 'غير معروف'}</td>
                        <td>${formatCurrency(payment.amount)}</td>
                        <td>${payment.method}</td>
                        <td>${new Date(payment.createdAt).toLocaleDateString('ar-SA')}</td>
                        <td>${payment.reference || 'لا يوجد'}</td>
                        <td><span class="status-badge status-${payment.status === 'completed' ? 'completed' : 'pending'}">${payment.status === 'completed' ? 'مكتمل' : 'معلق'}</span></td>
                        <td class="no-print">
                            <button onclick="generatePaymentReceipt('${payment.id}')" class="btn btn-sm btn-info"><i class="fas fa-receipt"></i>إيصال</button>
                        </td>
                    `;
            });
        }

        function populatePaymentOrderSelect() {
            const paymentOrderSelect = document.getElementById('paymentOrder');
            paymentOrderSelect.innerHTML = '<option value="">اختر الطلب</option>';
            const orders = dataManager.getOrders().filter(o => o.paymentStatus !== 'completed'); // Only show unpaid/partially paid orders
            const customers = dataManager.getCustomers();

            orders.forEach(order => {
                const customer = customers.find(c => c.id === order.customer);
                const option = document.createElement('option');
                option.value = order.id;
                option.textContent = `ط-${order.orderNumber} - ${customer ? customer.name : 'غير معروف'} (${formatCurrency(order.totalAmount - (order.paidAmount || 0))} متبقي)`;
                option.dataset.totalAmount = order.totalAmount;
                option.dataset.paidAmount = order.paidAmount || 0;
                paymentOrderSelect.appendChild(option);
            });
        }

        function updatePaymentStats() {
            const payments = dataManager.getPayments();
            const orders = dataManager.getOrders();
            const today = new Date().toISOString().split('T')[0];

            let todayPayments = 0;
            payments.filter(p => p.createdAt.startsWith(today)).forEach(p => todayPayments += p.amount);

            let pendingPayments = 0;
            let overduePayments = 0;
            orders.filter(o => o.paymentStatus !== 'completed').forEach(o => {
                pendingPayments += (o.totalAmount - (o.paidAmount || 0));
                // Simplified overdue: if order is old and not paid
                const orderDate = new Date(o.createdAt);
                const diffDays = Math.ceil((today.getTime() - orderDate.getTime()) / (1000 * 60 * 60 * 24));
                if (diffDays > 30) { // Overdue if more than 30 days old
                    overduePayments += (o.totalAmount - (o.paidAmount || 0));
                }
            });

            let monthlyPayments = 0;
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            payments.filter(p => p.createdAt.startsWith(currentMonth)).forEach(p => monthlyPayments += p.amount);

            document.getElementById('todayPayments').textContent = formatCurrency(todayPayments);
            document.getElementById('pendingPayments').textContent = formatCurrency(pendingPayments);
            document.getElementById('overduePayments').textContent = formatCurrency(overduePayments);
            document.getElementById('monthlyPayments').textContent = formatCurrency(monthlyPayments);
        }

        function processPayment() {
            document.getElementById('paymentForm').classList.remove('hidden');
            document.getElementById('paymentQRContainer').classList.add('hidden');
            // Clear form fields
            document.getElementById('paymentOrder').value = '';
            document.getElementById('paymentMethodSelect').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentDate').valueAsDate = new Date();
            document.getElementById('paymentReference').value = '';
            document.getElementById('paymentNotes').value = '';

            populatePaymentOrderSelect();
        }

        function submitPayment() {
            const orderId = document.getElementById('paymentOrder').value;
            const method = document.getElementById('paymentMethodSelect').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const reference = document.getElementById('paymentReference').value.trim();
            const notes = document.getElementById('paymentNotes').value.trim();

            if (!orderId || !method || isNaN(amount) || amount <= 0) {
                showAlert('يرجى اختيار الطلب، طريقة الدفع، وإدخال مبلغ صحيح.', 'error');
                return;
            }

            const order = dataManager.getOrders().find(o => o.id === orderId);
            if (!order) {
                showAlert('الطلب المحدد غير موجود.', 'error');
                return;
            }

            const currentPaid = order.paidAmount || 0;
            const remainingAmount = order.totalAmount - currentPaid;

            if (amount > remainingAmount) {
                showAlert(`المبلغ المدفوع (${formatCurrency(amount)}) يتجاوز المبلغ المتبقي (${formatCurrency(remainingAmount)}).`, 'warning');
                return;
            }

            const newPayment = { orderId, method, amount, date, reference, notes };
            if (dataManager.addPayment(newPayment)) {
                // Update order's paid amount and payment status
                order.paidAmount = (order.paidAmount || 0) + amount;
                if (order.paidAmount >= order.totalAmount) {
                    order.paymentStatus = 'completed';
                } else if (order.paidAmount > 0) {
                    order.paymentStatus = 'partial';
                }
                dataManager.updateOrder(order.id, order); // Save updated order

                showAlert('تم تسجيل الدفعة بنجاح!', 'success');
                document.getElementById('paymentForm').classList.add('hidden');
                renderPaymentsTable();
                updatePaymentStats();
                renderOrdersTable(); // To update payment status in orders table
            } else {
                showAlert('فشل تسجيل الدفعة.', 'error');
            }
        }

        function generatePaymentQR() {
            const orderId = document.getElementById('paymentOrder').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);

            if (!orderId || isNaN(amount) || amount <= 0) {
                showAlert('يرجى اختيار الطلب وإدخال مبلغ صحيح لتوليد رمز QR.', 'error');
                return;
            }

            const order = dataManager.getOrders().find(o => o.id === orderId);
            if (!order) {
                showAlert('الطلب المحدد غير موجود.', 'error');
                return;
            }

            const qrData = {
                type: 'payment',
                orderNumber: order.orderNumber,
                amount: amount,
                currency: currentCurrency,
                customerName: dataManager.getCustomers().find(c => c.id === order.customer)?.name || 'غير معروف',
                date: new Date().toISOString()
            };

            const qrCodeDiv = document.getElementById('paymentQRCode');
            qrCodeDiv.innerHTML = ''; // Clear previous QR code

            new QRCode(qrCodeDiv, {
                text: JSON.stringify(qrData),
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            document.getElementById('paymentQRContainer').classList.remove('hidden');
            showAlert('تم توليد رمز QR للدفع بنجاح!', 'info');
        }

        function generatePaymentReceipt(paymentId) {
            const payment = dataManager.getPayments().find(p => p.id === paymentId);
            if (!payment) {
                showAlert('الدفعة غير موجودة.', 'error');
                return;
            }
            const order = dataManager.getOrders().find(o => o.id === payment.orderId);
            const customer = order ? dataManager.getCustomers().find(c => c.id === order.customer) : null;

            const receiptHtml = `
                    <div class="invoice-section">
                        <div class="invoice-header">
                            <h2 class="text-3xl font-bold text-blue-700 mb-2">إيصال دفع</h2>
                            <p class="text-gray-600">رقم الإيصال: REC-${payment.id.slice(0, 8)}</p>
                            <p class="text-gray-600">التاريخ: ${new Date(payment.createdAt).toLocaleDateString('ar-SA')}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <h3 class="font-bold text-lg mb-2">معلومات العميل:</h3>
                                <p><strong>الاسم:</strong> ${customer ? customer.name : 'غير معروف'}</p>
                                <p><strong>الهاتف:</strong> ${customer ? customer.phone : 'غير معروف'}</p>
                            </div>
                            <div class="text-left">
                                <h3 class="font-bold text-lg mb-2">تفاصيل الدفعة:</h3>
                                <p><strong>رقم الطلب:</strong> ${order ? `ط-${order.orderNumber}` : 'غير معروف'}</p>
                                <p><strong>المبلغ المدفوع:</strong> ${formatCurrency(payment.amount)}</p>
                                <p><strong>طريقة الدفع:</strong> ${payment.method}</p>
                                <p><strong>رقم المرجع:</strong> ${payment.reference || 'لا يوجد'}</p>
                            </div>
                        </div>
                        <div class="mt-6 text-center">
                            <p class="text-gray-700">حالة الدفعة: <span class="status-badge status-completed">مكتملة</span></p>
                            <p class="text-gray-700 mt-2">شكراً لتعاملكم معنا!</p>
                        </div>
                        <div class="mt-8 text-center no-print">
                            <button onclick="printInvoice()" class="btn btn-primary mr-2"><i class="fas fa-print"></i>طباعة الإيصال</button>
                            <button onclick="this.parentNode.parentNode.remove()" class="btn btn-danger"><i class="fas fa-times"></i>إغلاق</button>
                        </div>
                    </div>
                `;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50';
            modal.innerHTML = receiptHtml;
            document.body.appendChild(modal);
        }

        // Advanced Analytics Functions
        function renderMonthlyRevenueChart() {
            if (monthlyRevenueChartInstance) monthlyRevenueChartInstance.destroy();
            const ctx = document.getElementById('monthlyRevenueChart').getContext('2d');
            const orders = dataManager.getOrders();

            const revenueByMonth = {};
            orders.forEach(order => {
                const monthYear = new Date(order.createdAt).toISOString().slice(0, 7); // YYYY-MM
                revenueByMonth[monthYear] = (revenueByMonth[monthYear] || 0) + order.totalAmount;
            });

            const sortedMonths = Object.keys(revenueByMonth).sort();
            const labels = sortedMonths.map(month => new Date(month).toLocaleString('ar', { month: 'long', year: 'numeric' }));
            const data = sortedMonths.map(month => revenueByMonth[month]);

            monthlyRevenueChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'الإيرادات الشهرية',
                        data: data,
                        backgroundColor: 'rgba(79, 172, 254, 0.2)',
                        borderColor: '#4facfe',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        function renderOrderStatusChart() {
            if (orderStatusChartInstance) orderStatusChartInstance.destroy();
            const ctx = document.getElementById('orderStatusChart').getContext('2d');
            const orders = dataManager.getOrders();

            const statusCounts = {
                'pending': 0,
                'in-progress': 0,
                'completed': 0,
                'cancelled': 0
            };
            orders.forEach(order => {
                if (statusCounts.hasOwnProperty(order.status)) {
                    statusCounts[order.status]++;
                }
            });

            const labels = ['قيد الانتظار', 'قيد التنفيذ', 'مكتمل', 'ملغى'];
            const data = [statusCounts.pending, statusCounts['in-progress'], statusCounts.completed, statusCounts.cancelled];
            const backgroundColors = [
                'rgba(255, 206, 86, 0.7)', // pending (yellow)
                'rgba(54, 162, 235, 0.7)', // in-progress (blue)
                'rgba(75, 192, 192, 0.7)', // completed (green)
                'rgba(255, 99, 132, 0.7)'  // cancelled (red)
            ];
            const borderColors = [
                'rgba(255, 206, 86, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(255, 99, 132, 1)'
            ];

            orderStatusChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12,
                                    family: 'Cairo'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCategoryPerformanceChart() {
            if (categoryPerformanceChartInstance) categoryPerformanceChartInstance.destroy();
            const ctx = document.getElementById('categoryPerformanceChart').getContext('2d');
            const orders = dataManager.getOrders();
            const items = dataManager.getItems();

            const categorySales = {};
            orders.forEach(order => {
                order.items.forEach(orderedItem => {
                    const item = items.find(i => i.id === orderedItem.id);
                    if (item) {
                        categorySales[item.category] = (categorySales[item.category] || 0) + (orderedItem.quantity * orderedItem.price);
                    }
                });
            });

            const labels = Object.keys(categorySales);
            const data = Object.values(categorySales);

            categoryPerformanceChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12,
                                    family: 'Cairo'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDriversPerformanceChart() {
            if (driversPerformanceChartInstance) driversPerformanceChartInstance.destroy();
            const ctx = document.getElementById('driversPerformanceChart').getContext('2d');
            const drivers = dataManager.getDrivers();
            const orders = dataManager.getOrders();

            const driverPerformance = {};
            drivers.forEach(driver => {
                driverPerformance[driver.name] = { totalTrips: 0, totalEarnings: 0, avgRating: 0, ratingsCount: 0 };
            });

            orders.forEach(order => {
                const driver = drivers.find(d => d.id === order.driver);
                if (driver) {
                    driverPerformance[driver.name].totalTrips++;
                    driverPerformance[driver.name].totalEarnings += order.totalAmount; // Simplified: assuming driver gets full order amount
                }
            });

            // For rating, we'd need a separate rating system per trip. For now, use stored rating.
            drivers.forEach(driver => {
                if (driverPerformance[driver.name]) {
                    driverPerformance[driver.name].avgRating = driver.rating;
                }
            });

            const labels = Object.keys(driverPerformance);
            const totalTripsData = labels.map(name => driverPerformance[name].totalTrips);
            const totalEarningsData = labels.map(name => driverPerformance[name].totalEarnings);
            const avgRatingData = labels.map(name => driverPerformance[name].avgRating);

            driversPerformanceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'إجمالي الرحلات',
                            data: totalTripsData,
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'إجمالي الأرباح',
                            data: totalEarningsData,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        }
                        // Could add average rating as a line chart on a third axis if needed
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'عدد الرحلات'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false // only draw grid lines for the first axis
                            },
                            title: {
                                display: true,
                                text: 'إجمالي الأرباح'
                            },
                            ticks: {
                                callback: function (value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function renderStockLevelsTable() {
            const stockLevelsTableBody = document.getElementById('stockLevelsTable');
            stockLevelsTableBody.innerHTML = '';
            const items = dataManager.getItems();

            if (items.length === 0) {
                stockLevelsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-600">لا توجد أصناف لعرض مستويات المخزون.</td></tr>';
                return;
            }

            items.forEach(item => {
                const status = item.stock <= item.minStock ? 'منخفض' : 'كافي';
                const action = item.stock <= item.minStock ? 'طلب شراء جديد' : 'لا يوجد';
                const statusClass = item.stock <= item.minStock ? 'low-stock' : '';

                const row = stockLevelsTableBody.insertRow();
                row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.category}</td>
                        <td>${item.stock} ${item.unit}</td>
                        <td>${item.minStock} ${item.unit}</td>
                        <td>${item.location}</td>
                        <td>${item.unit}</td>
                        <td><span class="${statusClass}">${status}</span></td>
                        <td>${action}</td>
                    `;
            });
        }

        function updateVATSummary() {
            const orders = dataManager.getOrders();
            let totalOrders = orders.length;
            let totalSalesBeforeTax = 0;
            let totalTaxAmount = 0;
            let totalSalesWithTax = 0;

            orders.forEach(order => {
                totalSalesBeforeTax += order.subtotal;
                totalTaxAmount += order.vatAmount;
                totalSalesWithTax += order.totalAmount;
            });

            document.getElementById('vatTotalOrders').textContent = totalOrders;
            document.getElementById('vatTotalSales').textContent = formatCurrency(totalSalesBeforeTax);
            document.getElementById('vatTotalTax').textContent = formatCurrency(totalTaxAmount);
            document.getElementById('vatTotalWithTax').textContent = formatCurrency(totalSalesWithTax);
        }

        function updateProfitabilityAnalysis() {
            const orders = dataManager.getOrders();
            const maintenanceRecords = dataManager.getMaintenanceRecords();
            const drivers = dataManager.getDrivers();
            const accountants = dataManager.getAccountants();

            let totalRevenue = orders.reduce((sum, order) => sum + order.totalAmount, 0);
            let totalMaintenanceCost = maintenanceRecords.reduce((sum, record) => sum + record.cost, 0);
            let totalSalaries = drivers.reduce((sum, driver) => sum + driver.salary, 0) + accountants.reduce((sum, acc) => sum + acc.salary, 0);

            // Simplified profit calculation: Revenue - (Maintenance + Salaries)
            // In a real system, this would be much more complex, including item costs, fuel, etc.
            let totalExpenses = totalMaintenanceCost + totalSalaries;
            let totalProfit = totalRevenue - totalExpenses;
            let profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100).toFixed(2) : 0;

            document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('profitMargin').textContent = `${profitMargin}%`;
        }

        // Security and Audit Functions
        function renderAuditLog() {
            const auditLogContainer = document.getElementById('auditLogContainer');
            auditLogContainer.innerHTML = '';
            const logs = dataManager.getAuditLogs();

            if (logs.length === 0) {
                auditLogContainer.innerHTML = '<p class="text-gray-600 text-center py-4">لا توجد سجلات مراجعة حالياً.</p>';
                return;
            }

            logs.forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.className = 'audit-log';
                logDiv.innerHTML = `
                        <p class="font-semibold">${log.action} <span class="text-gray-500 text-sm ml-2">${new Date(log.timestamp).toLocaleString('ar-SA')}</span></p>
                        <p class="text-sm text-gray-700">المستخدم: ${log.user} | التفاصيل: ${log.details}</p>
                    `;
                auditLogContainer.appendChild(logDiv);
            });
        }

        function updateSecurityStats() {
            const logs = dataManager.getAuditLogs();
            const today = new Date();
            const twentyFourHoursAgo = new Date(today.getTime() - (24 * 60 * 60 * 1000));

            const failedLogins = logs.filter(log =>
                log.action === 'محاولة دخول فاشلة' && new Date(log.timestamp) > twentyFourHoursAgo
            ).length;

            const successfulOperations = logs.filter(log =>
                log.action !== 'محاولة دخول فاشلة' && new Date(log.timestamp).toISOString().startsWith(today.toISOString().split('T')[0])
            ).length;

            // Active users is simplified for this demo, usually requires real-time tracking
            const activeUsers = new Set(logs.filter(log =>
                new Date(log.timestamp) > twentyFourHoursAgo
            ).map(log => log.user)).size;

            document.getElementById('failedLogins').textContent = failedLogins;
            document.getElementById('successfulOperations').textContent = successfulOperations;
            document.getElementById('activeUsers').textContent = activeUsers;
        }

        function renderUsersTable() {
            const usersTableBody = document.getElementById('usersTable');
            usersTableBody.innerHTML = '';
            const users = dataManager.getData(dataManager.storageKeys.users);
            const auditLogs = dataManager.getAuditLogs();

            users.forEach(user => {
                const userLogs = auditLogs.filter(log => log.user === user.name);
                const lastLogin = userLogs.filter(log => log.action === 'تسجيل دخول').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                const lastLoginTime = lastLogin ? new Date(lastLogin.timestamp).toLocaleString('ar-SA') : 'لم يسجل دخول بعد';
                const totalOperations = userLogs.length;

                const row = usersTableBody.insertRow();
                row.innerHTML = `
                        <td class="font-medium">${user.username}</td>
                        <td><span class="status-badge" style="background: ${user.role === 'admin' ? '#fee2e2' : user.role === 'accountant' ? '#fef3c7' : '#dbeafe'}; color: ${user.role === 'admin' ? '#991b1b' : user.role === 'accountant' ? '#92400e' : '#1e40af'};">${user.role === 'admin' ? 'مدير النظام' : user.role === 'accountant' ? 'محاسب' : 'سائق'}</span></td>
                        <td>${lastLoginTime}</td>
                        <td>${totalOperations}</td>
                        <td><span class="status-badge ${user.active ? 'status-completed' : 'status-cancelled'}">${user.active ? 'نشط' : 'معطل'}</span></td>
                        <td class="no-print">
                            <button onclick="toggleUserStatus('${user.username}')" class="btn btn-sm ${user.active ? 'btn-danger' : 'btn-success'}">${user.active ? 'تعطيل' : 'تفعيل'}</button>
                        </td>
                    `;
            });
        }

        function toggleUserStatus(username) {
            const users = dataManager.getData(dataManager.storageKeys.users);
            const userIndex = users.findIndex(u => u.username === username);
            if (userIndex !== -1) {
                users[userIndex].active = !users[userIndex].active;
                dataManager.saveData(dataManager.storageKeys.users, users);
                dataManager.addAuditLog('تغيير حالة مستخدم', `تم ${users[userIndex].active ? 'تفعيل' : 'تعطيل'} المستخدم: ${username}`);
                showAlert(`تم ${users[userIndex].active ? 'تفعيل' : 'تعطيل'} المستخدم ${username} بنجاح.`, 'success');
                renderUsersTable();
            } else {
                showAlert('المستخدم غير موجود.', 'error');
            }
        }

        function exportAuditLog() {
            const logs = dataManager.getAuditLogs();
            const data = logs.map(log => ({
                'التاريخ والوقت': new Date(log.timestamp).toLocaleString('ar-SA'),
                'المستخدم': log.user,
                'الإجراء': log.action,
                'التفاصيل': log.details,
                'عنوان IP': log.ip
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "سجل المراجعة");
            XLSX.writeFile(wb, "سجل_المراجعة.xlsx");
            dataManager.addAuditLog('تصدير', 'تم تصدير سجل المراجعة إلى Excel');
            showAlert('تم تصدير سجل المراجعة بنجاح!', 'success');
        }

        function clearAuditLog() {
            if (confirm('هل أنت متأكد من مسح سجل المراجعة بالكامل؟ لا يمكن التراجع عن هذا الإجراء.')) {
                dataManager.saveData(dataManager.storageKeys.auditLog, []);
                dataManager.addAuditLog('مسح السجل', 'تم مسح سجل المراجعة بالكامل');
                showAlert('تم مسح سجل المراجعة بنجاح!', 'success');
                renderAuditLog();
                updateSecurityStats();
            }
        }

        // Data Export/Import Functions
        function exportDataJSON() {
            const data = dataManager.exportAllData();
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transportation_management_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showAlert('تم تصدير البيانات كملف JSON بنجاح!', 'success');
        }

        function exportDataExcel() {
            const allData = {
                items: dataManager.getItems(),
                orders: dataManager.getOrders(),
                customers: dataManager.getCustomers(),
                drivers: dataManager.getDrivers(),
                accountants: dataManager.getAccountants(),
                maintenance: dataManager.getMaintenanceRecords(),
                payments: dataManager.getPayments()
            };

            const wb = XLSX.utils.book_new();

            for (const key in allData) {
                if (allData.hasOwnProperty(key)) {
                    const sheetName = {
                        items: 'الأصناف',
                        orders: 'الطلبات',
                        customers: 'العملاء',
                        drivers: 'السائقين',
                        accountants: 'المحاسبين',
                        maintenance: 'الصيانة',
                        payments: 'المدفوعات'
                    }[key] || key;

                    const ws = XLSX.utils.json_to_sheet(allData[key]);
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            }

            XLSX.writeFile(wb, "بيانات_نظام_النقل.xlsx");
            dataManager.addAuditLog('تصدير', 'تم تصدير جميع بيانات النظام إلى Excel');
            showAlert('تم تصدير البيانات كملف Excel بنجاح!', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const jsonData = event.target.result;
                            if (dataManager.importAllData(jsonData)) {
                                showAlert('تم استيراد البيانات بنجاح! سيتم تحديث الواجهة.', 'success');
                                // Re-render all active components
                                showTab(document.querySelector('.nav-tab.active').getAttribute('onclick').match(/'([^']+)'/)[1]);
                            } else {
                                showAlert('فشل استيراد البيانات. تأكد من صحة تنسيق الملف.', 'error');
                            }
                        } catch (error) {
                            showAlert('خطأ في قراءة الملف أو تحليل البيانات.', 'error');
                            console.error('Import error:', error);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is already logged in (e.g., from a previous session)
            // For this demo, we'll always show login screen first.
            // In a real app, you'd check dataManager.currentUser or a session token.
            // If (dataManager.getCurrentUser()) {
            //     document.getElementById('loginContainer').style.display = 'none';
            //     document.getElementById('mainContent').style.display = 'block';
            //     document.getElementById('currentUser').textContent = dataManager.getCurrentUser().name;
            //     setupUserInterface(dataManager.getCurrentUser().role);
            //     showTab('dashboard');
            // } else {
            //     document.getElementById('loginContainer').style.display = 'flex';
            // }

            // Set default date for customer join date and maintenance date
            document.getElementById('customerJoinDate').valueAsDate = new Date();
            document.getElementById('maintenanceDate').valueAsDate = new Date();
            document.getElementById('paymentDate').valueAsDate = new Date();

            // Initial render of dashboard
            updateDashboardStats();
            renderSalesChart();
            renderPopularItemsChart();
            checkSmartAlerts();
            renderRecentOrders();
        });
    </script>
</body>
</html>
